# 战斗演出系统设计文档 v4.0

> **版本**: 4.0 (完整实施版)
> **状态**: 包含概念设计、技术实施、配置规范
> **目标**: 提供从理论到实践的完整演出系统设计

---

## 第一部分：核心概念

### 1. 核心术语词典 (Terminology & Definitions)

在阅读本文档前，请先统一以下概念的定义。

#### 1.1 演出阶段定义
*   **Action (主动阶段)**: 攻击方发起进攻的描述。它负责确立攻击的**意图 (Intent)** 和 **视觉氛围**。
*   **Reaction (被动阶段)**: 防御方应对攻击的描述。它负责根据 **判定结果 (Result)** 和 **接收意图** 对战斗进行收尾。
*   **Round (回合)**: 战斗中的最小时间单位，包含一次完整的 `Action + Reaction` 交互。

#### 1.2 数据概念定义
*   **Intent (意图)**: 攻击的物理属性标签（如：光束、实弹、精神波）。它是连接 Action 与 Reaction 的握手协议。
*   **Result (结果)**: 战斗引擎计算出的客观数值结果（如：Miss, Dodge, Parry, Block, Hit, Crit）。
*   **Snapshot (快照)**: 战斗计算完成后生成的只读数据包，包含 HP 变化、Buff 触发、判定结果等。

#### 1.3 优先级层级定义 (The T-Hierarchy)
系统在选择演出模版时，严格遵循以下优先级：

| 层级   | 名称                     | 定义                                                           | 典型用途                                            | 竞争机制                            |
| :----- | :----------------------- | :------------------------------------------------------------- | :-------------------------------------------------- | :---------------------------------- |
| **T0** | **剧情强制 (Scripted)**  | **最高指令**。由关卡脚本或特殊状态强制注入，无视任何战斗逻辑。 | Boss 变身台词、剧情必杀、初号机暴走、强制撤退。     | **独占抢占** (一旦存在，跳过 T1-T3) |
| **T1** | **高光时刻 (Highlight)** | **逻辑归因**。基于技能、性格或状态的个性化演出。               | 技能发动的 Cut-in、暴击特写、新人类感应、底力台词。 | **加权竞标** (T1 内部比拼分数)      |
| **T2** | **战术细节 (Tactical)**  | **物理归因**。基于武器类型和物理规则的通用描述。               | 光束步枪的射击、实弹被盾牌弹开、近战拼刀。          | **条件匹配** (First Match)          |
| **T3** | **通用保底 (Fallback)**  | **安全网**。仅描述"A 攻击了 B"的基础文本。                     | 防止因配置缺失导致的报错或空白。                    | **恒定存在**                        |

---

### 2. 交互时机与生命周期 (Timing & Lifecycle)

针对"Action 何时触发"及"是否延迟下一回合"的疑问，本系统采用 **"预计算 + 异步回放"** 模式。

#### 2.1 核心原则：计算与演出分离
战斗逻辑层（后端）瞬间完成计算，演出层（前端）按顺序回放。**演出不会阻塞逻辑计算，但会阻塞玩家的操作权。**

#### 2.2 标准回合生命周期图解

```text
[后端: 毫秒级]
1. 战斗请求 -> 2. 逻辑计算(造成伤害/判定结果) -> 3. 生成快照(Snapshot) 
                                           |
                                           v
[生成层: 映射逻辑]
4. 意图提取 -> 5. 模版匹配(T0->T3) -> 6. 文本/资源打包 -> 7. 发送 JSON 给前端

[前端: 秒级回放]
8. 解析 JSON -> 9. 播放 Action 动画/文本 (约 1.5s)
                -> 10. (无缝衔接) 播放 Reaction 动画/文本 (约 1.5s)
                -> 11. 更新 UI (血条/状态)
                -> 12. 解锁下一回合操作 (或自动进行下一回合)
```

#### 2.3 关键问答
*   **Q: Action 何时触发？**
    *   A: 在前端接收到后端数据包后，作为回合演出的第一阶段立即触发。
*   **Q: Reaction 是否会延迟下一回合？**
    *   A: **视觉上会，逻辑上不会。** 前端必须等 Action+Reaction 的动画队列播放完毕（约 3-4 秒），才会显示后续文字演出或被玩家点击鼠标直接显示所有结果。这是为了保证叙事的连贯性。

---

### 3. T1 内部竞标详解 (The T1 Bidding Pool)

T1 层级是演出的核心，负责解释"为什么会发生这个结果"。为了解决技能冲突，采用 **加权竞标 (Weighted Bidding)** 机制。

#### 3.1 权重分配表

| 子类            | 权重分 (Score) | 描述                   | 例子                                           |
| :-------------- | :------------- | :--------------------- | :--------------------------------------------- |
| **T1-A (扭转)** | **100**        | 改变了判定结果的技能。 | [必闪] 生效、[必中] 生效、[分身] 触发          |
| **T1-B (爆发)** | **80**         | 极大的数值增强技能。   | [热血]、[魂]、[暴击]、[铁壁]                   |
| **T1-C (特质)** | **50**         | 角色/机体被动特性。    | [性格: 傲娇]、[机体: 刚大木合金]、[状态: 濒死] |

#### 3.2 竞标逻辑
1.  **收集**: 获取所有触发的 T1 模版。
2.  **过滤**: 剔除与当前 `Result` 不符的模版（如：[必中] 模版必须对应 `Result=HIT`）。
3.  **决胜**: 选择分数最高的一组。若有多个同分，随机选取。
4.  **降权 (De-weighting)**: 为了防止同台词刷屏，若某 ID 本回合胜出，下回合其权重临时 -30。

---

### 4. 全景示例场景 (Scenario Walkthrough)

以下通过两个具体案例，展示数据流如何在各层级间流转。

#### 场景 A：新人类的觉醒 (技能触发 + 闪避)

**1. 输入快照 (Input Snapshot)**
*   **Attacker**: 扎古 (使用机枪, Intent: `PROJ_RAIN`)
*   **Defender**: 高达 (HP: 100%, 触发技能: `NEWTYPE_FLASH`, 结果: `DODGE`)

**2. 模版匹配过程**
*   **Action 阶段**:
    *   T0: 无。
    *   T1: 无特殊技能。
    *   T2: 匹配到 `Weapon=MachineGun`。
    *   *Output Intent*: `INTENT_PROJECTILE_RAIN` (实弹弹幕)
    *   *Action Text*: "扎古举起机枪，向前方倾泻出密集的弹幕！"

*   **Reaction 阶段**:
    *   *Input Intent*: `INTENT_PROJECTILE_RAIN`
    *   T0: 无。
    *   **T1 (竞标)**:
        *   候选1: `NEWTYPE_FLASH` (权重 100) -> **胜出**
        *   候选2: `GUNDAM_ARMOR` (权重 50) -> 落选
    *   *Check*: 技能要求 `Result=DODGE`? -> 满足。
    *   *Reaction Text*: "额头闪过一道电光！高达仿佛预知了弹道轨迹，在弹幕缝隙中以最小幅度完成了规避。"

**3. 最终输出 (Final Output)**
> **[Action]** 扎古举起机枪，向前方倾泻出密集的弹幕！
> **[Reaction]** 额头闪过一道电光！高达仿佛预知了弹道轨迹，在弹幕缝隙中以最小幅度完成了规避。

---

#### 场景 B：绝望的铁壁 (技能触发 + 格挡)

**1. 输入快照 (Input Snapshot)**
*   **Attacker**: 大魔 (使用火箭炮, Intent: `PROJ_SINGLE`)
*   **Defender**: 钢加农 (HP: 5%, 触发技能: `IRON_WALL` (铁壁), 结果: `BLOCK`)

**2. 模版匹配过程**
*   **Action 阶段**:
    *   T0: 无。
    *   T1: 无。
    *   T2: 匹配到 `Weapon=Bazooka`。
    *   *Output Intent*: `INTENT_PROJECTILE_SINGLE` (单发实弹)
    *   *Action Text*: "大魔肩部的巨型火箭炮喷出火舌，一枚高爆弹头直袭而来！"

*   **Reaction 阶段**:
    *   *Input Intent*: `INTENT_PROJECTILE_SINGLE`
    *   T0: 无。
    *   **T1 (竞标)**:
        *   候选1: `IRON_WALL` (权重 80) -> **胜出**
        *   候选2: `STATE_DYING` (濒死台词, 权重 50) -> 落选
    *   *Check*: 技能要求 `Result=BLOCK`? -> 满足。
    *   *Reaction Text*: ""这种程度的攻击……还没完！" 钢加农并未退缩，凭借'铁壁'般的意志，正面硬接了爆炸的冲击。"

**3. 最终输出 (Final Output)**
> **[Action]** 大魔肩部的巨型火箭炮喷出火舌，一枚高爆弹头直袭而来！
> **[Reaction]** "这种程度的攻击……还没完！" 钢加农并未退缩，凭借'铁壁'般的意志，正面硬接了爆炸的冲击。

---

## 第二部分：技术实施框架

### 5. 数据契约 (Data Contracts)

#### 5.1 RawAttackEvent - 原始攻击事件

**定义位置**: `src/presentation/models.py`

```python
@dataclass
class RawAttackEvent:
    """原始攻击事件 - 战斗引擎生成的纯数据事件"""
    
    # 基本信息
    round_number: int              # 回合数
    attacker_id: str               # 攻击方机体ID
    defender_id: str               # 防御方机体ID
    attacker_name: str             # 攻击方机体名称
    defender_name: str             # 防御方机体名称
    
    # 武器信息
    weapon_id: str                 # 使用的武器ID
    weapon_name: str               # 武器名称
    weapon_type: str               # MELEE/SHOOTING/AWAKENING/SPECIAL
    
    # 判定结果
    attack_result: str             # MISS/DODGE/PARRY/BLOCK/HIT/CRIT
    damage: int                    # 造成的伤害
    
    # 战场状态
    distance: int                  # 当前距离(米)
    attacker_will_delta: int       # 攻击方气力变化
    defender_will_delta: int       # 防御方气力变化
    
    # 技能触发
    triggered_skills: List[str]    # 本回合触发的技能ID列表
    
    # 标记
    is_first_attack: bool          # 是否为本回合第一次攻击
```

#### 5.2 PresentationAttackEvent - 演出攻击事件

```python
@dataclass
class PresentationAttackEvent:
    """演出攻击事件 - 包含文本、视觉效果的完整演出数据"""
    
    # 事件分类
    event_type: str               # ACTION/REACTION
    round_number: int             # 回合数
    
    # 文本内容
    text: str                     # 完整的演出文本
    display_tags: List[str]       # 显示标签(用于UI高亮)
    
    # 视觉资源
    tier: str                     # T0_SCRIPTED/T1_HIGHLIGHT/T2_TACTICAL/T3_FALLBACK
    anim_id: str                  # 动画资源ID
    camera_cam: str               # 镜头运动类型
    vfx_ids: List[str]            # 特效资源ID列表
    sfx_ids: List[str]            # 音效资源ID列表
    
    # 战斗数据
    damage_display: int           # 显示的伤害值
    hit_location: str             # 命中部位
    
    # 原始数据引用
    raw_event: Optional[RawAttackEvent]
```

---

### 6. 意图系统 (Intent System)

#### 6.1 VisualIntent 定义

**定义位置**: `src/presentation/constants.py`

```python
class VisualIntent(str, Enum):
    """标准物理意图 - 描述攻击的物理本质"""
    
    # 格斗类
    SLASH_LIGHT = "INTENT_SLASH_LIGHT"      # 快速切削
    SLASH_HEAVY = "INTENT_SLASH_HEAVY"      # 重型斩击
    STRIKE_BLUNT = "INTENT_STRIKE_BLUNT"    # 钝器打击
    
    # 射击类
    BEAM_INSTANT = "INTENT_BEAM_INSTANT"    # 瞬发光束
    BEAM_MASSIVE = "INTENT_BEAM_MASSIVE"    # 高能照射
    PROJECTILE_SINGLE = "INTENT_PROJECTILE_SINGLE"  # 单发实弹
    PROJECTILE_RAIN = "INTENT_PROJECTILE_RAIN"      # 连续实弹
    
    # 特殊类
    IMPACT_MASSIVE = "INTENT_IMPACT_MASSIVE"  # 质量撞击
    PSYCHO_WAVE = "INTENT_PSYCHO_WAVE"        # 精神攻击
    AOE_BURST = "INTENT_AOE_BURST"            # 范围爆发
```

#### 6.2 武器类型与意图映射表

为了确保逻辑层与表现层的解耦，系统通过以下映射关系确定初始意图：

| 武器类型 (WeaponType) | 备选物理意图 (Standard Intents)                  | 说明                                   |
| :-------------------- | :----------------------------------------------- | :------------------------------------- |
| **MELEE (格斗)**      | SLASH_LIGHT, SLASH_HEAVY, STRIKE_BLUNT           | 默认根据武器 Tag (如 `Heavy`) 细化     |
| **SHOOTING (射击)**   | BEAM_INSTANT, PROJECTILE_SINGLE, PROJECTILE_RAIN | 默认根据 `tags` (如 `MachineGun`) 区分 |
| **AWAKENING (觉醒)**  | PSYCHO_WAVE                                      | 典型的 Newtype/强化人专用武器          |
| **HEAVY (重武器)**    | BEAM_MASSIVE, IMPACT_MASSIVE                     | 强调破坏力的长前摇攻击                 |
| **FALLBACK (撞击)**   | IMPACT_MASSIVE                                   | 失去能量或极近距离下的被动攻击         |
| **SPECIAL (特殊)**    | AOE_BURST (待定), PSYCHO_WAVE                    | 通常由技能或特定武器覆盖意图           |

---

### 7. 标准意图字典 (Standard Intent Dictionary)

意图是对攻击"物理本质"的抽象。Reaction 必须基于这些本质来描述不同的判定结果。

**设计原则**：每个Intent必须对应全部6种判定结果（MISS, DODGE, PARRY, BLOCK, HIT, CRIT），确保物理完备性。

#### 7.1 INTENT_SLASH_LIGHT (快速切削)

**典型武器**: 光束军刀、实弹短刀

| 判定结果  | 物理表现 (Reaction描述)                    |
| :-------- | :----------------------------------------- |
| **MISS**  | 刀锋擦过空气，未能触及目标                 |
| **DODGE** | 侧影被残光照亮，本体已不在原处             |
| **PARRY** | 近身拼刀，火花四溅，刀刃交错的金属鸣响刺耳 |
| **BLOCK** | 盾牌边缘被切出浅痕，火星溅射               |
| **HIT**   | 装甲表面留下细长熔痕，金属被削开           |
| **CRIT**  | 刀刃精准斩断关键传感器/关节，零件崩飞      |

#### 7.2 INTENT_SLASH_HEAVY (重型斩击)

**典型武器**: 巨剑、热能斧

| 判定结果  | 物理表现 (Reaction描述)                     |
| :-------- | :------------------------------------------ |
| **MISS**  | 巨大刃器挥空，惯性使机体失衡                |
| **DODGE** | 在刀锋落下前瞬间脱离，推进器全功率爆发      |
| **PARRY** | 巨响中剑身偏转，双方武器震颤                |
| **BLOCK** | 盾牌火花飞溅、机身受压下沉，驾驶舱剧烈震动  |
| **HIT**   | 装甲被整块撕裂，金属碎片四散                |
| **CRIT**  | 斩断手臂/推进器等主要结构，机体瞬间失去平衡 |

#### 7.3 INTENT_STRIKE_BLUNT (钝器打击)

**典型武器**: 拳击、踢击、流星锤

| 判定结果  | 物理表现 (Reaction描述)                  |
| :-------- | :--------------------------------------- |
| **MISS**  | 扑空踉跄，惯性使机体向前倾斜             |
| **DODGE** | 利用推进器突然变向，避开钝击轨迹         |
| **PARRY** | 双臂交叉格挡，吸收冲击力                 |
| **BLOCK** | 骨架发出沉闷的金属扭曲声，装甲明显凹陷   |
| **HIT**   | 装甲内陷、外挂零件震飞，传感器被震碎     |
| **CRIT**  | 剧烈震荡使驾驶员晕眩，驾驶舱系统短暂瘫痪 |

#### 7.4 INTENT_BEAM_INSTANT (光束瞬发)

**典型武器**: 光束步枪、短激光

| 判定结果  | 物理表现 (Reaction描述)                  |
| :-------- | :--------------------------------------- |
| **MISS**  | 光束擦肩而过，留下焦痕和空气电离的臭氧味 |
| **DODGE** | 机身边缘空气被电离，残光照亮侧影         |
| **PARRY** | 光束军刀切开光束，能量中和产生闪光       |
| **BLOCK** | 抗光束涂层蒸发形成雾气，盾牌表面烧蚀     |
| **HIT**   | 光束熔穿装甲，金属四处飞溅，留下贯穿孔   |
| **CRIT**  | 精准熔穿核心部位，引发内部诱爆           |

#### 7.5 INTENT_BEAM_MASSIVE (高能照射)

**典型武器**: 大口径扩散炮、胸部炮

| 判定结果  | 物理表现 (Reaction描述)                      |
| :-------- | :------------------------------------------- |
| **MISS**  | 粗大光柱擦过机体，远处地面被犁出深沟         |
| **DODGE** | 在光柱到达前全速脱离，热浪掀起机体           |
| **PARRY** | (物理不合理，回退到通用描述)                 |
| **BLOCK** | 护盾光晕剧烈扩张并过载，能量泄漏             |
| **HIT**   | 装甲大面积熔化，机体被推后数十米             |
| **CRIT**  | 机体被淹没在光柱中，产生巨大贯穿伤，结构解体 |

#### 7.6 INTENT_PROJECTILE_SINGLE (精确单发实弹)

**典型武器**: 狙击炮、反舰火箭

| 判定结果  | 物理表现 (Reaction描述)                  |
| :-------- | :--------------------------------------- |
| **MISS**  | 远处的地面被掀起巨量土石，弹头深深嵌入   |
| **DODGE** | 擦出的火星溅在监视器上，弹头呼啸而过     |
| **PARRY** | (物理不合理，回退到通用描述)             |
| **BLOCK** | 盾牌被贯穿，弹头嵌入但未完全穿透         |
| **HIT**   | 装甲被直接撕开空洞，延迟引爆造成内部损伤 |
| **CRIT**  | 弹头击中弹药舱/动力炉，殉爆炸飞半个机体  |

#### 7.7 INTENT_PROJECTILE_RAIN (实弹弹幕)

**典型武器**: 导弹齐射、火神炮扫射

| 判定结果  | 物理表现 (Reaction描述)                |
| :-------- | :------------------------------------- |
| **MISS**  | 弹幕散布过大，全部射偏，周围烟尘弥漫   |
| **DODGE** | 在弹雨缝隙中高速机动，残影穿梭         |
| **PARRY** | 用武器击落部分弹头，其他弹药擦身而过   |
| **BLOCK** | 盾牌上连续不断的火星爆炸，盾面千疮百孔 |
| **HIT**   | 全身被烟雾和爆炸覆盖，装甲多处破损     |
| **CRIT**  | 密集弹头集中命中同一部位，结构崩坏     |

#### 7.8 INTENT_IMPACT_MASSIVE (质量撞击)

**典型武器**: 机体冲撞、陨石投掷

| 判定结果  | 物理表现 (Reaction描述)                |
| :-------- | :------------------------------------- |
| **MISS**  | 撞碎残垣断壁，巨大冲击波掀起尘土       |
| **DODGE** | 在冲击到达前侧身翻滚，避开正面碰撞     |
| **PARRY** | 双臂推挡卸力，被推出数米               |
| **BLOCK** | 盾牌严重变形，驾驶员失去平衡，地面碎裂 |
| **HIT**   | 结构性损毁，机体被撞飞，关节脱臼       |
| **CRIT**  | 驾驶舱遭受致命冲击，系统全面崩溃       |

#### 7.9 INTENT_PSYCHO_WAVE (精神/多向攻击)

**典型武器**: 浮游炮、精神力场

| 判定结果  | 物理表现 (Reaction描述)                |
| :-------- | :------------------------------------- |
| **MISS**  | 感应波扩散过大，未能锁定目标           |
| **DODGE** | 凭借Newtype直觉预知攻击方向，提前规避  |
| **PARRY** | 释放同频感应波干扰，抵消攻击           |
| **BLOCK** | 生成力场屏障，扭曲空间吸收攻击         |
| **HIT**   | 毫无规律的点状穿透，多处装甲同时被击穿 |
| **CRIT**  | 精神波直接冲击驾驶员意识，造成精神创伤 |

---

**物理完备性检查清单**：
- [ ] 每个Intent都有完整的6种判定结果描述
- [ ] 物理不合理的组合（如"高能光束被招架"）已标注并回退到通用描述
- [ ] 所有描述符合物理逻辑（光束=熔穿，实弹=爆炸，钝击=震荡）

---

### 8. 实施阶段规划 (Implementation Phases)

#### Phase 1: 基础架构 (Week 1-2)

**目标**: 建立核心数据模型和意图系统

**任务清单**:
- [ ] 创建 `src/presentation/constants.py` - 定义 `VisualIntent` 枚举
- [ ] 创建 `src/presentation/models.py` - 定义数据契约
- [ ] 创建 `src/presentation/intent_extractor.py` - 实现意图提取
- [ ] 编写单元测试验证

**验收标准**:
- Intent 系统能正确从武器配置提取意图
- 数据模型能正确序列化/反序列化

---

#### Phase 2: 模版系统 (Week 3-4)

**目标**: 实现T2/T3层级的物理描述

**任务清单**:
- [ ] 创建 `src/presentation/template.py` - 定义模版类
- [ ] 创建 `src/presentation/registry.py` - 实现模版注册表
- [ ] 创建 `src/presentation/selector.py` - 实现模版选择器
- [ ] 创建 `config/presentation_templates.yaml` - 配置T2/T3模版
- [ ] 填写物理完备性矩阵 (所有 Intent × Result 组合)

**验收标准**:
- 所有 Intent × Result 组合都有对应的T2模版
- T3兜底模版能处理所有未定义情况

---

#### Phase 3: T1竞标系统 (Week 5-6)

**目标**: 实现技能高光时刻

**任务清单**:
- [ ] 实现 `CooldownManager` - 降权持久化
- [ ] 在 `TemplateSelector` 中实现T1竞标逻辑
- [ ] 配置核心技能的T1模版 (必中、必闪、热血、铁壁)
- [ ] 实现技能触发事件订阅

**验收标准**:
- 技能触发时能选择对应的T1模版
- 竞标权重系统正常工作
- 降权机制防止刷屏

---

####  Phase 4: T0与集成 (Week 7-8)

**目标**: 完成剧情演出和战斗引擎集成

**任务清单**:
- [ ] 实现 `ScriptedPresentationManager` - T0管理器
- [ ] 创建 `EventMapper` - 完整映射流程
- [ ] 在 `CombatEngine` 中集成演出系统
- [ ] 端到端测试

**验收标准**:
- T0能正确抢占T1-T3
- 完整战斗回合能生成正确的演出事件

---

## 9. 总结与展望

### 9.1 核心成就

v4.0 版本的核心在于**完整的技术框架**：
1.  **明确了定义**: T0 是神之手，T1 是逻辑解释，T2 是物理规则，T3 是保底。
2.  **明确了时机**: 演出是逻辑计算后的"回放录像"，Action/Reaction 是连续播放的两个片段。
3.  **明确了流转**: 通过 Intent 串联，通过 Bidding 决策，确保最重要的信息永远优先展示。
4.  **明确了实施**: 提供完整的数据契约、意图系统、模版架构和分阶段实施计划。

### 9.2 扩展方向

- **Cut-in系统**: 为关键技能添加插画特写
- **Camera系统**: 根据Intent和Result动态切换镜头
- **VFX管线**: 建立特效资源映射表
- **本地化支持**: 多语言文本模版系统