# 战斗演出系统 (CPS) v5.0 开发蓝图：大模型指引版
**核心目标**：根除表现脱节（图文不符）、消灭模板爆炸（组合解耦）、解决语境同质化（多样化填充）。
**设计哲学**：**少写死代码，多写通用方法**。让系统像“大导演”一样根据战斗数据现场调度，而非简单地播放静态模板。

---

## 一、 核心范式转移：逻辑从“顺向”转为“逆推”

在实现任何逻辑前，必须明确演出系统的核心权重：**结局（Result） > 意图（Intent） > 技能（Skill）**。

*   **逻辑（逆推/结果导向）**：
    **[看结局]** → **[锁死频道]** → **[攻防解耦竞标]** → **[原子化组件拼装]** → **[动态词缀注入]**。
    *成果：结局绝对正确，攻防描述自由组合，文本变体呈指数级增长。*

---

## 二、 四层导演金字塔架构 (The 4-Layer Pipeline)

所有输入数据 `RawAttackEvent` 必须依次流经这四个逻辑层，禁止跨层处理。

### 📍 Layer 1：绝对律令层 (Absolute Directives) —— 【逻辑安检】
**职责**：分配“频道”，从源头杜绝物理冲突与演出悖论。

#### 机制 1：结果导向前置路由 (Outcome-First Routing / ODR)
**核心理念：【结局即一切】。** 在系统的第一毫秒，就根据数值层面的“终局”划定演出领土。

**方法论与实施步骤：**
1.  **终局扫描 (Conclusion Scan)**：
    *   **一类优先级 (致死判定)**：检查 `is_lethal` (HP <= 0)。若为真，强制路由至 **[FATAL]**。
    *   **二类优先级 (行为判定)**：若非致死，检查 `attack_result`。
        *   若结果为 `MISS/DODGE/PARRY`，路由至 **[EVADE]**。
        *   若结果为 `HIT/CRIT/BLOCK`，路由至 **[IMPACT]**。
    *   **三类优先级 (特殊语境)**：检查 `is_support` 或 `is_counter`。

2.  **频道领土锁定 (Channel Locking)**：这一步是“事前路由”。系统将后续的所有组件检索（动作、受击、运镜）全部锁死在对应频道的索引分片中，彻底杜绝逻辑穿帮。

3.  **数据输入契约 (The Contract)**：引擎必须在 `RawAttackEvent` 中精准提供：`is_lethal`、`is_counter`、`is_support` 以及 `attack_result`。

### 📍 Layer 2：剧本解构层 (Scripting) —— 【解耦与降维】
**职责**：解决模板爆炸。

#### 机制 3：动反双轨独立竞标 (Dual-Track Bidding)
**核心理念：【攻守分离，万物皆可组】。**
*   **方法论**：将传统的“大一统模板”解耦为 **Action（攻击方）** 与 **Reaction（防御方）** 两段独立的剧本。
*   **实施步骤**：系统生成两张选票。
    *   一张带 `VisualIntent` 指向 **Action 库**（选出：“{attacker}举起光束步枪，连续扣动扳机！”）。
    *   一张带 `Channel` 指向 **Reaction 库**（选出：“{defender}的盾牌爆出了剧烈的能量闪光！”）。
*   **组合红利**：若有 10 种攻击描述和 10 种受击描述，仅需配置 20 个原子模板即可产生 100 种各异的合奏，数量呈指数级下降。

#### 机制 4：视觉意图与物理类 (Gundam Physics Classes)
**核心理念：【逻辑还原，硬核背景】。** 基于高达世界观的底层物理，约束演出的表现边界。
*   **四大物理类 (Physics Anchors)**：
    1.  **Energy (能量类 - Beam/Mega Particle)**：
        *   **逻辑**：高热、高能。
        *   **背景互动**：若 Result 为 BLOCK 且装备抗光束披风/ABC，描述为“涂层迅速蒸发导致的能量雾气”；若为打击 I-Field，描述为“光束在感应场表面扭曲消散”。不可出现实体武器格挡（除非是 Beam Saber 对削）。
    2.  **Kinetic (实弹类 - Projectile/Ballistic)**：
        *   **逻辑**：动能、破片、爆炸。
        *   **背景互动**：击中 PS 装甲（Phase Shift）时，强调“装甲受震动吸收导致弹头弹开”；对防御力场（GN Field）则是“剧烈波纹”。
    3.  **Impact (撞击类 - Tackle/Massive)**：
        *   **逻辑**：位移、结构变形。强调关节受压声、机体踉跄、镜头重震。
    4.  **Blade (切削类 - Slash)**：
        *   **逻辑**：刃性、局部切割。
        *   **背景互动**：区分“热能刃”的熔融效果与“光束军刀”的粒子撕裂感。

### 📍 Layer 3：动态丰满层 (Dynamic Enrichment) —— 【消灭同质化】
**职责**：让每一句话都独一无二。

#### 机制 5：T2 原子化动态组合 (Atomic Assembly)
**核心理念：【三段式拼装，拒绝小作文】。**
*   **方法论**：将 T2 文本进一步拆解。`Text = [启动姿态] + [执行过程] + [结果反馈]`。
*   **实施逻辑**：
    *   **[手段]**：根据意图。*（如“全推力冲锋，挥动热能斧，”）*
    *   **[反馈]**：根据结果细节。*（如“狠狠斩断了目标的平衡翼！”）*
*   **动态性**：由系统在运行时抓取碎片，彻底解决反复看到相同长难句的疲劳感。

#### 机制 6：语义化变量注入 (SVI / Semantic Injection)
**核心理念：【万物皆可替换】。**
*   **方法论**：强制将技能和语境状态作为变量嵌入。
    *   `{skill_name}`：优先显示触发的高光技能（如【三倍速】），其次是武器。
    *   `{hit_part}`：随机选取核心节点（头部主摄像机、肢体关节、推进器端口）。

#### 机制 7：(内容已移动至后续开发计划)

#### 机制 12：动态受击部位映射 (Dynamic Hit Location - DHL)
**核心理念：【视觉精准性，击中而非笼统】。**
*   **方法论**：基于判定结果检索部位库。**FATAL** 锁定关键节点（驾驶舱等）；**CRIT** 锁定精密部位（摄像机等）；**HIT** 锁定外甲。
*   **文本反馈**：部位变量 `{hit_part}` 会驱动渲染层生成对应的视觉损毁效果。

#### 机制 13：损伤量级与血量预警 (Damage Grading & HP Context)
**核心理念：【相对数值叙事】。**
*   **方法论**：引入 **Damage/MaxHP** 比例换算。将描述分为 **骚扰级 (<10%)**、**有效级 (10-30%)**、**重创级 (30-60%)** 和 **毁灭级 (>60%)**。
*   **HP 状态注入**：Layer 3 会根据防御方当前 %HP 注入追加状态词（如“勉强支撑”）。

### 📍 Layer 4：视听调度层 (AV Dispatch) —— 【影视级调色】
**职责**：将文字翻译成镜头与节奏。

(本层级高级特性已移动至后续开发计划)

---

## 三、 数据建模指引 (Data Contract)

大模型在生成逻辑时，请务必遵循以下结构：

### 1. 引擎契约 (RawAttackEvent 增量字段)
*   `spirit_commands`: 列表。这是触发 T1 高光的直接触发器。
*   `is_counter / is_support`: 布尔值。触发特殊频道的开关。

### 2. 模板建模 (YAML 结构建议)
```yaml
# 原子化组件示例
sub_components:
  intent_prep:
    BEAM: ["锁定目标能量特征后，", "随着电荷汇聚完毕，"]
  execution:
    SHOOTING: ["{attacker}连续扣动扳机，{action_name}倾泻而出！"]
  context_finish:

```

## 四、 核心逻辑构建模式 (Implementation Pattern)

`EventMapper.map_attack` 的伪代码模式：

1.  **Init**：读取 `event`。
2.  **L1**：`channel` = **Route(event)**；`correction` = **Guard(intent, result)**。
3.  **L2**：`act_bone` = **Bid_Action(intent, cd_check)**；`react_bone` = **Bid_Reaction(channel, cd_check)**。
4.  **L3**：`final_text` = **Assemble(act_bone, react_bone, variables)**。
5.  **L4**：`presentation` = **Dispatch_AV(text, event_data)**。
6.  **Return**：返回最终演出对象。

---

## 五、 系统增强与后续开发计划 (System Enhancement Plan)

本章节涵盖了系统从中级向高级演化所需的配套逻辑，建议在 Core Pipeline 稳定后逐步落地。

### 阶段 A：语境适配与逻辑一致性 (Refinement)
*   **机制 2：一致性纠偏 (The Context Adapter)**：
    *   *方法*：处理数值命中与技能表现的冲突。当触发闪避技能但被迫扣血时，在 **Layer 1** 强制锁定 **Graze (擦弹)** 语境，利用“虽开启残影但因敌方敌方预判更强而受损”的逻辑圆场。

### 阶段 B：叙事深度与机师交互 (Narrative)
*   **机制 7：宿命交互拦截 (Rivalry Interception)**：
    *   *方法*：在 **Layer 2** 检索前，基于 `Rivalry_Matrix` 生成 T0 拦截模板。
    *   *防疲劳*：对同一对宿敌应用 3-5 回合的硬性冷却 (Hard CD)。

### 阶段 C：视听自动化与疲劳抑制 (Audiovisual & Decay)
*   **机制 8：启发式镜头调度**：
    *   *方法*：基于 `Distance`、`Damage`、`Result`、`Relationship` 四大维度构建规则树。
*   **机制 9：多维权重衰减**：
    *   *方法*：在竞标池中引入“模板 ID”、“意图标签”、“语义指纹”三大深度的负反馈降权。
*   **机制 10：语义化时间轴自适应**：
    *   *方法*：根据结果（暴击增益 0.5s）和意图（光束持续 0.3s）动态调整动作间隔。
