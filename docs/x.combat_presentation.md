# 战斗演出系统技术规范 (Technical Specification) v5.0

> **核心架构**: 四层导演金字塔 (Four-Layer Pipeline)
> **设计范式**: 逻辑解耦、动态合成、启发式调度
> **目标**: 针对“导演系统”如何将干瘪的数据转化为动态影视级战报的实施规范

---

## 版本历史

| 版本 | 日期 | 核心变更 |
| :--- | :--- | :------- |
| v4.0 | - | T-Hierarchy 单一维度体系，Action/Reaction 共用模板池 |
| v5.0 | 2026-02 | 重构为四层金字塔架构，引入10大机制，双轨竞标，语境注入 |

---

## 第一部分：系统架构总览

### 1. 设计哲学：导演逻辑自动化
演出系统的核心挑战在于**如何解决“模板爆炸”的同时保证“逻辑一致性”**。

**核心方法论**：
1. **结果前置 (Outcome-First)**: 物理逻辑必须优先于艺术表达。
2. **语义解耦 (Semantic Decoupling)**: 攻防描述独立竞标，通过“意图”握手。
3. **启发式注入 (Heuristic Injection)**: 利用“语境变量”和“关系矩阵”消除重复。

### 2. 四层金字塔架构

```
                    ┌─────────────────────────────────────┐
                    │     Layer 4: 视听调度层 (AV Layer)    │
                    │   机制7-10: 镜头、防疲劳、环境、时间轴  │
                    │   一句话职责：打造影视级镜头与反馈       │
                    ├─────────────────────────────────────┤
                    │     Layer 3: 动态丰满层 (Dynamic)     │
                    │   机制5-6: 语境注入、宿敌交互           │
                    │   一句话职责：消灭文字重复与枯燥感       │
                    ├─────────────────────────────────────┤
                    │     Layer 2: 剧本解构层 (Scripting)   │
                    │   机制3-4: 双轨竞标、意图抽象           │
                    │   一句话职责：解决模板爆炸与复用问题     │
                    ├─────────────────────────────────────┤
                    │     Layer 1: 绝对律令层 (Absolute)    │
                    │   机制1-2: 结果路由、逻辑纠偏           │
                    │   一句话职责：保证逻辑正确性（不可违背）  │
                    └─────────────────────────────────────┘
```

### 3. 数据流向图

```
RawAttackEvent
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: 绝对律令层                                          │
│ ├─ 机制1: 结果导向前置路由 → 分配频道 (FATAL/EVADE/IMPACT)      │
│ └─ 机制2: 技能逻辑纠偏 → 剔除物理不合理模板                    │
│ Output: RoutedEvent (频道标记 + 纠偏标记)                      │
└─────────────────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: 剧本解构层                                          │
│ ├─ 机制3: 动反双轨独立竞标 → ActionPool + ReactionPool         │
│ └─ 机制4: 视觉意图抽象降维 → 提取本质意图标签                   │
│ Output: ScriptedEvent (动作剧本 + 反应剧本 + 意图标签)          │
└─────────────────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: 动态丰满层                                          │
│ ├─ 机制5: 语境动态注入 → 填充词缀池、技能名嵌入                 │
│ └─ 机制6: 机师宿命交互 → 宿敌/羁绊矩阵查询                     │
│ Output: EnrichedEvent (丰满文本 + 关系标记)                    │
└─────────────────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: 视听调度层                                          │
│ ├─ 机制7: 启发式镜头推导 → cam_id 选择                        │
│ ├─ 机制8: 多维降权防疲劳 → 历史记录降权计算                    │
│ ├─ 机制9: 环境/地形因子干涉 → 环境修饰词注入                   │
│ └─ 机制10: 语义化时间轴自适应 → delay 计算                    │
│ Output: PresentationEvent (完整演出事件)                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 第二部分：核心术语与方法论

### 2.1 基础术语（v4.0 保留）

| 术语 | 定义 | 作用域 |
| :--- | :--- | :------- |
| **Action** | 攻击方发起进攻的描述阶段 | 演出时序 |
| **Reaction** | 防御方应对攻击的描述阶段 | 演出时序 |
| **Intent** | 攻击的物理属性标签（光束/实弹/精神波） | 意图匹配 |
| **Result** | 战斗判定结果（MISS/DODGE/PARRY/BLOCK/HIT/CRIT） | 结果路由 |
| **T-Hierarchy** | 模板优先级分类（T0-T3），现作为分类标签使用 | 模板分类 |

### 2.2 四层架构新术语

#### Layer 1: 绝对律令层

| 术语 | 定义 | 设计方法论 |
| :--- | :--- | :------- |
| **频道 (Channel)** | 基于结果本质的模板分类：FATAL/EVADE/IMPACT | 结果决定频道，而非模板决定结果 |
| **前置路由 (Pre-Routing)** | 在模板选择前，根据 Result 强制分配频道 | 保证逻辑正确性的第一道关卡 |
| **纠偏 (Correction)** | 剔除物理不合理的模板组合 | 防违和过滤机制 |

#### Layer 2: 剧本解构层

| 术语 | 定义 | 设计方法论 |
| :--- | :--- | :------- |
| **双轨竞标 (Dual-Track Bidding)** | Action 和 Reaction 各自独立竞标 | 分离攻守两侧的叙事空间 |
| **竞标池 (Bidding Pool)** | 符合当前条件的候选模板集合 | 分层级、分权重的竞争空间 |
| **视觉意图抽象 (Visual Abstraction)** | 从具体武器到物理本质的降维过程 | 物理本质 → 动作形态 → 规模层级 |

#### Layer 3: 动态丰满层

| 术语 | 定义 | 设计方法论 |
| :--- | :--- | :------- |
| **语义注入 (Semantic Injection)** | 动态填充词缀、技能名、状态词 | 消灭文本重复感的核心手段 |
| **词缀池 (Lexicon Pool)** | 按类别组织的可替换词库 | {adverb}、{hit_part}、{action_name} |
| **宿敌矩阵 (Rivalry Matrix)** | 定义机师间特殊关系的配置表 | 阿姆罗↔夏亚、卡缪↔花 等经典组合 |
| **羁绊矩阵 (Bond Matrix)** | 定义机师间羁绊关系的配置表 | 用于触发专属互动对话 |

#### Layer 4: 视听调度层

| 术语 | 定义 | 设计方法论 |
| :--- | :--- | :------- |
| **启发式调度 (Heuristic Scheduling)** | 基于规则推导的镜头选择 | 距离 → 结果 → 意图 → 默认 |
| **降权曲线 (Decay Curve)** | 模板重复使用的权重衰减函数 | 多维降权：模板/实体/语义 |
| **环境因子 (Environmental Factor)** | 战场环境对演出的修饰 | 地面扬尘、宇宙无声爆炸 |
| **语义化时间轴 (Semantic Timeline)** | 基于语义结果的延迟计算 | 暴击+0.5s、闪避-0.3s |

### 2.3 核心处理链逻辑
1. **Channeling**: 分配频道（FATAL/EVADE/IMPACT）。
2. **Filtering**: 剔除物理矛盾（如“光束被招架”）。
3. **Bidding**: 攻防双轨独立评分竞标。
4. **Enriching**: 注入变量（技能名、词组、宿敌台词）。
5. **Dispatching**: 推导镜头、时间轴、环境特效。

---

## 第三部分：绝对律令层（机制1-2）

### 机制1：结果导向前置路由 (Outcome-First Routing)
**目的**：分配战斗基调频道，彻底杜绝表现层悖论（如“致死后仍在闪避”）。

**逻辑算法**：
1. **输入阶段**：获取 `RawAttackEvent.is_lethal` 和 `RawAttackEvent.attack_result`。
2. **频道仲裁 (Channel Arbitration)**：
    *   优先级 1: `is_lethal == True` → 路由至 **[FATAL]** 频道。
    *   优先级 2: `attack_result` ∈ {MISS, DODGE, PARRY} → 路由至 **[EVADE]** 频道。
    *   优先级 3: `attack_result` ∈ {BLOCK, HIT, CRIT} → 路由至 **[IMPACT]** 频道。
3. **输出效应**：后续所有候选模板搜索必须仅在对应的 `Channel` 子集内进行。

| 频道 | 触发条件 | 描述 | 不可覆盖性 |
| :--- | :--- | :--- | :--- |
| **FATAL** | HP <= 0 | 致命击毁频道 | 最高，无视 T-Hierarchy |
| **EVADE** | Result ∈ {MISS, DODGE, PARRY} | 规避类频道 | 强制隔离 |
| **IMPACT** | Result ∈ {BLOCK, HIT, CRIT} | 命中类频道 | 强制隔离 |
| **SUPPORT** | `is_support == True` | 支援攻击/防御频道 | 引入双机位镜头逻辑 |
| **COUNTER** | `is_counter == True` | 反击前置频道 | 允许防御方提前切入特殊台词 |

#### 数据输入引擎契约 (Engine Content Contract)

为支持前置路由与精准导演，`RawAttackEvent` 必须从战斗引擎获取以下关键增量信息：

1. **精神指令状态 (Spirit Commands)**: 如 `hot_blood`, `flash`, `soul`。这是触发 T1 主角高光的直接指令。
2. **反击标记 (Counter Flag)**: 标识本次攻击是否为防御方的反击，用于切换“逆转”基调。
3. **支援上下文 (Support Context)**: 包含支援者的 ID、位置及其对应的判定结果。
4. **环境精细度 (Terrain Detail)**: 区分“水下”、“森林”、“城市”，用于 Layer 4 触发尘土或水花特效。
5. **战力等级差 (Power Level Gap)**: 两个机体间的实力悬殊（如 Boss vs 杂鱼），用于触发“轻视”或“绝望”类文字。

#### 工作流程（方法论）

```
1. 识别结果本质
   └─ 读取 Result 字段
   └─ 计算 HP 变化

2. 分配对应频道
   ├─ HP <= 0 → FATAL频道 → 强制使用 T0_LETHAL 或 T1致命模板
   ├─ MISS/DODGE/PARRY → EVADE频道 → 只匹配规避类模板
   └─ BLOCK/HIT/CRIT → IMPACT频道 → 只匹配命中类模板

3. 避免跨频道污染
   └─ 频道边界为硬边界，T-Hierarchy 仅在频道内部生效
   └─ T0_SCRIPTED 可跨频道（剧情强制）
```

#### 设计要点

- **频道是预筛选**：不是选择后的过滤，而是选择前的分区
- **EVADE 与 IMPACT 永不交集**：一个事件不可能同时进入两个频道
- **FATAL 可叠加**：在 IMPACT 频道内，若 HP<=0，叠加 FATAL 标记

---

### 机制2：一致性纠偏 (Consistency Guard / Context Adapter)
**目的**：解决数据结算与视觉预期的冲突，作为表现层的“语境适配器”。

**设计哲学**：纠偏不是为了掩盖真相，而是为了**“合理解释”**数据冲突（如：触发了闪避技能但依然被命中）。

**纠偏逻辑策略**：
1. **优先匹配意图**：如果引擎结果是 HIT，但机师触发了高等级闪避技能，系统将强制锁定在 [IMPACT] 频道，但选取“擦弹/险些避开”之类的 **擦伤/流弹模板**。
2. **文本补偿注入**：在文本中注入补偿语句（如：“虽然开启了残像，但对手的直觉更胜一筹！”）。

**纠偏矩阵 (Correction Matrix)**：
| 组合场景 | 逻辑矛盾点 | 适配动作 (Adapter Action) |
| :--- | :--- | :--- |
| Beam + PARRY | 物理规则冲突 | 降级为 DODGE 或 BLOCK（描述为光束被偏转） |
| Psycho + BLOCK | 逻辑规则冲突 | 降级为 HIT（描述为精神穿透）或 EVADE |
| Dodge Skill + HIT Result | 技能体验冲突 | 分配至 IMPACT，但强制使用 **Graze（擦刺）** 模板 |
| Crit Result + Normal Hit | 演出力度不足 | 强制注入 `cam_dramatic_zoom` 与 `cam_shake_heavy` |

#### 表现力保底设计

**问题场景**：当某个 Intent × Result 组合没有配置模板时，系统不能崩溃，也不能留白。

**保底策略**：
1. **T3 通用模板**：每个频道必须配置至少一个 T3 兜底模板
2. **动态生成**：当配置缺失时，使用简化语法动态生成文本
   - 格式：`{attacker}以{weapon}攻击了{defender}，{result_description}`
3. **降级回退**：若 T2 无匹配，自动降级至 T3

#### T3 保底模板设计原则

```yaml
# 保底模板示例结构
T3_FALLBACK:
  channel: IMPACT
  conditions:
    result: [HIT, CRIT, BLOCK]
  content:
    action_text: "{attacker}以{weapon}发动了攻击。"
    reaction_text: "{defender}{result_description}。"
  # 关键：保留所有变量位置，确保即使无配置也能输出
```

---

## 第四部分：剧本解构层（机制3-4）

### 机制3：动反双轨独立竞标

#### 核心理念

**Action 和 Reaction 是两场独立的叙事，各自拥有自己的竞标池。**

v4.0 的问题：Action 和 Reaction 共用模板，导致组合灵活性不足。一个优秀的攻击描述可能被迫搭配一个平庸的防御描述。

v5.0 的解决：分离竞标池，Action 选 Action 的，Reaction 选 Reaction 的。

#### 双轨架构

```
┌─────────────────────────────────────────────────────────────┐
│                     原始事件 RawAttackEvent                    │
└─────────────────────────────────────────────────────────────┘
                         │
          ┌──────────────┴──────────────┐
          ▼                             ▼
┌─────────────────────┐      ┌─────────────────────┐
│   Action Bidding    │      │  Reaction Bidding   │
│       Pool          │      │       Pool          │
├─────────────────────┤      ├─────────────────────┤
│ 竞标维度：           │      │ 竞标维度：           │
│ • 武器类型           │      │ • 视觉意图           │
│ • 攻击者技能         │      │ • 判定结果           │
│ • 攻击者状态         │      │ • 防御者技能         │
│ • 距离/地形          │      │ • 防御者状态         │
├─────────────────────┤      ├─────────────────────┤
│ 权重体系：           │      │ 权重体系：           │
│ • T1-A 扭转: 100    │      │ • T1-A 扭转: 100    │
│ • T1-B 爆发: 80     │      │ • T1-B 爆发: 80     │
│ • T1-C 特质: 50     │      │ • T1-C 特质: 50     │
│ • T2 物理: 0        │      │ • T2 物理: 0        │
└─────────────────────┘      └─────────────────────┘
          │                             │
          ▼                             ▼
┌─────────────────────┐      ┌─────────────────────┐
│  Selected Action    │      │ Selected Reaction   │
│     Template        │      │    Template         │
└─────────────────────┘      └─────────────────────┘
          │                             │
          └──────────────┬──────────────┘
                         ▼
              ┌─────────────────────┐
              │   Combined Output   │
              │  [Action, Reaction] │
              └─────────────────────┘
```

#### 权重体系（v4.0 继承与扩展）

| 子类 | 权重分 | Action 池适用场景 | Reaction 池适用场景 |
| :--- | :--- | :---------------- | :------------------ |
| T1-A (扭转) | 100 | 必中、破防 | 必闪、分身 |
| T1-B (爆发) | 80 | 热血、魂 | 铁壁、不屈 |
| T1-C (特质) | 50 | 新人类觉醒、性格 | 底力、濒死台词 |

#### 竞标流程方法论

```
1. 分离
   └─ 根据 event_type 将候选模板分流至两个池

2. 筛选（每层内部）
   └─ T1层：收集所有触发的技能模板
   └─ T2层：匹配武器类型和意图
   └─ T3层：兜底模板

3. 决胜
   └─ T1层内部按权重分决胜
   └─ T2层按条件匹配，随机选取
   └─ T3层恒定存在

4. 合并
   └─ Action 模板 + Reaction 模板 → 完整演出序列
```

---

### 机制4：视觉意图抽象降维

#### 核心理念

**从"这是什么武器"抽象到"这是什么物理本质"。**

#### 三层抽象方法论

```
Layer 3: 规模层级（最后考虑）
    ├─ 单发 (Single)
    ├─ 连射/覆盖 (Rain)
    └─ 范围/全屏 (AOE)

Layer 2: 动作形态（其次考虑）
    ├─ 斩击 (Slash) ── 有刃、切割伤害
    ├─ 打击 (Strike) ── 钝器、冲击伤害
    └─ 射击 (Shoot) ── 投射、贯穿伤害

Layer 1: 物理本质（优先决定）
    ├─ 光束 (Beam) ── 能量、熔穿、无法招架
    ├─ 实弹 (Projectile) ── 动能、爆炸、可击落
    ├─ 精神 (Psycho) ── 感应、穿透、特殊交互
    └─ 质量 (Impact) ── 碰撞、震荡、巨大动能
```

#### 决策流程

```
武器输入
    │
    ├─ 1. 识别物理本质
    │      ├─ tags 包含 "beam" → Beam
    │      ├─ tags 包含 "projectile" → Projectile
    │      ├─ tags 包含 "psycho" → Psycho
    │      └─ 否则 → Impact
    │
    ├─ 2. 识别动作形态
    │      ├─ weapon_type = MELEE → Slash/Strike
    │      ├─ weapon_type = SHOOTING → Shoot
    │      └─ weapon_type = SPECIAL → 根据技能定
    │
    └─ 3. 识别规模层级
           ├─ tags 包含 "machinegun" / "vulcan" → Rain
           ├─ tags 包含 "map_weapon" → AOE
           └─ 否则 → Single

输出：VisualIntent = {物理本质}_{动作形态}_{规模层级}
      或简化为：物理本质 + 动作形态（规模可省略）
```

#### 标准意图定义（v4.0 保留并扩展）

完整意图字典见第8章。此处强调抽象方法论的应用：

| Intent | 物理本质 | 动作形态 | 规模 | 典型武器 |
| :--- | :--- | :--- | :--- | :--- |
| SLASH_LIGHT | - | Slash | 轻 | 光束军刀 |
| SLASH_HEAVY | - | Slash | 重 | 巨剑、热能斧 |
| STRIKE_BLUNT | - | Strike | - | 拳击、锤 |
| BEAM_INSTANT | Beam | Shoot | 单 | 光束步枪 |
| BEAM_MASSIVE | Beam | Shoot | 大 | 扩散炮 |
| PROJECTILE_SINGLE | Projectile | Shoot | 单 | 狙击炮 |
| PROJECTILE_RAIN | Projectile | Shoot | 连 | 导弹、火神 |
| IMPACT_MASSIVE | Impact | Strike | 大 | 冲撞、陨石 |
| PSYCHO_WAVE | Psycho | Wave | - | 浮游炮 |
| AOE_BURST | - | Burst | 范围 | 地图炮 |

---

## 第五部分：动态丰满层（机制5-6）

### 机制5：语境动态注入与词缀池

#### 核心理念

**没有两次完全相同的攻击，文本应该反映这种差异。**

#### 随机词库设计

```yaml
# 词缀池配置示例
lexicon_pool:
  adverb_action:  # 动作副词
    - "迅猛地"
    - "精准地"
    - "毫不留情地"
    - "以教科书般的姿势"

  adverb_hit:  # 命中副词
    - "精准地"
    - "深深地"
    - "毫无偏差地"

  hit_part:  # 命中部位
    - "驾驶舱"
    - "动力炉"
    - "头部传感器"
    - "主推进器"
    - "左臂关节"

  dodge_style:  # 闪避风格
    newtype:
      - "仿佛预知了弹道般"
      - "以不可思议的角度"
    normal:
      - "在推进器全开下"
      - "以一个惊险的侧翻"

  # 词库选择策略：基于角色性格、战斗状态过滤
  filters:
    character_personality:
      "冷静": ["精准地", "计算好距离后"]
      "热血": ["怒吼着", "不顾一切地"]
      "傲娇": ["嘴上说着不屑，手上却"]
```

#### 技能名替换策略

**强制嵌入原则**：技能名必须出现在演出文本中。

```
模板结构：
"{attacker}发动了{skill_name}！{adverb}挥出{weapon}！"

实际输出：
"阿姆罗发动了【新人类觉醒】！以不可思议的角度挥出光束军刀！"

关键：即使模板中未显式定义{skill_name}位置，
      系统也会在 Action 开头强制插入技能宣告
```

#### 词库选择策略

```
输入：角色状态 + 角色性格 + 战斗阶段

处理流程：
1. 加载全局词库
2. 应用角色性格过滤器 → 缩小可选范围
3. 应用战斗状态过滤器 → 进一步缩小
4. 随机选取（或按权重选取）

示例：
角色：阿姆罗（性格：冷静）
状态：HP<30%（底力觉醒）

词库选择：
- adverb_action: 从冷静性格子集中选 → "精准地"
- 但 HP 低时，额外加入底力相关词 → "带着决绝的意志，精准地"
```

---

### 机制6：机师交互系统 (Pilot Interaction Matrix)
**目的**：处理特定单位/机师间的专用对话。

**拦截逻辑 (Interception)**：
此机制位于 **Layer 2 (剧本解构层)**，在常规模板竞标前进行。
*   若命中宿敌关系，生成一个 `T1_RIVALRY` 虚拟模板，其优先级最高。
*   **防重复机制 (Anti-Repetitive)**：
    *   **CD 强制冷却**：同一宿敌对话触发后，进入 3-5 回合的强制 CD，期间回退到通用特质对话。
    *   **随机变体**：同一关系配置 3+ 组对话变体，按历史权重降权。

**检索权重 (Priority Hierarchy)**：
1. **Rivalry (宿敌)**: 优先级最高，用于决定性时刻。
2. **Bond (羁绊)**: 优先级次之，用于支援或危机时刻。
3. **Trait (特质)**: 通用性格/身份对话。

#### 羁绊矩阵

定义机师之间的羁绊关系，通常是正面情感。

```yaml
bond_matrix:
  kamille_vs_fa:
    parties: ["卡缪·维丹", "花·园丽"]
    relationship: "青梅竹马"
    trigger_conditions:
      - "一方受到致命攻击"
      - "另一方在支援范围内"
    effects:
      defender_support:
        - "卡缪！小心！"
        - "我不会让你受伤的！"

  amuro_vs_lalah:
    parties: ["阿姆罗·雷", "拉拉·辛"]
    relationship: "灵魂共鸣"
    trigger_conditions:
      - "任何一方使用新人类技能"
    effects:
      simultaneous_awareness:
        - "这是...拉拉的声音？"
        - "阿姆罗...你在那里吗..."
```

#### 触发条件与优先级计算

```
优先级计算公式：
Final_Priority = Base_Priority + Relationship_Boost + Context_Boost

其中：
- Base_Priority: 模板基础权重
- Relationship_Boost: 宿敌/羁绊加成（通常50-100）
- Context_Boost: 上下文加成（濒死、技能触发等）

触发检查流程：
1. 检查当前战斗双方是否在矩阵中
2. 检查触发条件是否满足
3. 若满足，将专属对话加入竞标池，并应用优先级加成
4. 正常竞标流程，但专属对话有更高胜出概率
```

---

## 第六部分：视听调度层（机制7-10）

### 机制7：启发式镜头推导

#### 核心理念

**镜头不是随机选的，是推导出来的。**

#### 镜头类型定义

| 镜头ID | 名称 | 适用场景 | 推导优先级 |
| :--- | :--- | :--- | :--- |
| cam_long_shot | 远景 | 距离 > 800m | Distance |
| cam_close_up | 近景 | 距离 < 100m | Distance |
| cam_dramatic_zoom | 戏剧变焦 | CRIT 结果 | Result |
| cam_shake_light | 轻震 | HIT 小伤害 | Result + Damage |
| cam_shake_heavy | 重震 | HIT 大伤害 | Result + Damage |
| cam_tracking_evade | 追踪镜头 | DODGE 结果 | Result |
| cam_cockpit | 驾驶舱视角 | 技能特写 | Skill |
| cam_split_screen | 分屏 | 宿敌对战 | Relationship |

#### 推导规则（优先级降序）

```
镜头推导决策树：

1. 【最高】脚本强制
   └─ 若 T0_SCRIPTED 指定了 cam_id → 直接使用

2. 【高】关系场景
   └─ 若触发宿敌/羁绊交互 → cam_split_screen 或 cam_cockpit

3. 【中】结果导向
   ├─ CRIT → cam_dramatic_zoom
   ├─ DODGE → cam_tracking_evade
   ├─ HIT + damage > 500 → cam_shake_heavy
   ├─ HIT + damage <= 500 → cam_shake_light
   └─ 其他 → 进入下一步

4. 【低】距离导向
   ├─ distance > 800 → cam_long_shot
   ├─ distance < 100 → cam_close_up
   └─ 其他 → cam_default

5. 【保底】默认
   └─ cam_default
```

#### Action 与 Reaction 的镜头差异

```
Action 阶段镜头特点：
- 强调攻击发起
- 常用：cam_close_up（攻击者）、cam_long_shot（战场全貌）
- 技能触发时：cam_cockpit（展示驾驶员）

Reaction 阶段镜头特点：
- 强调结果反馈
- 常用：cam_shake_*（受击反馈）、cam_tracking_evade（闪避轨迹）
- 致命一击：cam_dramatic_zoom（展示破坏）
```

---

### 机制8：多维降权与冷却系统 (Decay & CD System)
**目的**：通过权重动态调节与物理冷却，保证演出多样性。

**衰减维度 (Decay Vectors)**：
*   **Template Decay**: 单一模板执行后的基础倍率衰减（$-30$）。
*   **Category Decay**: 同类意图（如“光束射击”）连续触发的累积惩罚（$-15$）。
*   **Entity Decay**: 同一单位短时间内连续触发高光的情绪疲劳（$-20$）。

**冷却机制 (CD Mechanism)**：
对于 T1 级别以上的“高光模板”，引入硬性冷却周期。
*   **Cooldown (Turns)**: 触发后锁定 2-4 回合。
*   **Logic**: `If Current_Turn - Last_Used_Turn < CD_Threshold: Weight = 0`。
*   **作用位置**：此逻辑在 **Layer 2 竞标阶段** 作为硬性前过滤执行。

**恢复模型**：$W_{current} = W_{base} \times (1 - \lambda)^{turns}$，其中 $\lambda$ 为衰减常数。

#### 降权曲线公式

```
当前权重 = 基础权重 - 降权惩罚

降权惩罚计算：
Penalty = Σ(维度惩罚 × 衰减系数)

其中衰减系数随时间恢复：
Decay_Factor(t) = max(0, 1 - t/恢复周期)

t 为距离上次使用的回合数
```

#### 实现方法论

```
数据结构：
{
  template_usage: {
    "template_id": { last_used_round: N, consecutive_uses: M }
  },
  entity_usage: {
    "entity_id": { intent_tags_used: [...], timestamps: [...] }
  },
  semantic_signature: {
    "template_id": "语义指纹向量"
  }
}

处理流程：
1. 每次模板选择前，计算各候选模板的当前有效权重
2. 有效权重 = 基础权重 - 各维度惩罚
3. 选择有效权重最高的模板
4. 记录本次使用，更新降权状态
5. 每回合结束，应用恢复（按恢复速度减少惩罚）
```

---

### 机制9：环境/地形因子干涉

#### 核心理念

**同样的攻击，在宇宙和地面是不同的景象。**

#### 环境分类与修饰规则

**地面环境 (Surface)**

| 环境因素 | 触发条件 | 修饰效果 |
| :--- | :--- | :--- |
| 扬尘 | 攻击落地/被格挡 | 添加"烟尘四起"、"尘土飞扬"描述 |
| 地面撞击 | 机体倒地/冲撞 | 添加"地面碎裂"、"留下焦痕"描述 |
| 残骸 | 机体被击毁后 | 战场中增加"燃烧的残骸"、"扭曲的金属"元素 |

**宇宙环境 (Space)**

| 环境因素 | 触发条件 | 修饰效果 |
| :--- | :--- | :--- |
| 无声爆炸 | 任何爆炸 | 添加"无声的闪光"、"在真空中静静绽放的火球" |
| AMBAC 机动 | 闪避动作 | 强调"姿态制御喷嘴"、"惯性控制" |
| 残骸漂浮 | 机体被击毁后 | 添加"残骸在虚空中缓缓旋转"、"碎片漂浮" |
| 推进器尾焰 | 高速机动 | 强调"推进器光芒"、"轨迹云" |

**特殊地形**

| 地形 | 特殊规则 |
| :--- | :--- |
| 殖民卫星内部 | 强调"封闭空间"、"回声"、"结构受损警报" |
| 陨石带 | 强调"利用掩体"、"碎石碰撞" |
| 大气层边缘 | 强调"摩擦发热"、"轨迹云" |

#### 模板修饰规则

```
修饰符插入位置：
- Action 后：环境对攻击的影响
- Reaction 前：环境对结果的修饰

示例：
原始 Action: "扎古举起机枪，向前方倾泻出密集的弹幕！"
地面修饰: "扎古举起机枪，在扬尘中向前方倾泻出密集的弹幕！"
宇宙修饰: "扎古举起机枪，在推进器光芒映照下向前方倾泻出密集的弹幕！"

原始 Reaction: "高达在弹幕缝隙中完成了规避。"
地面修饰: "高达在弹幕缝隙中完成了规避，扬起的尘土遮蔽了视线。"
宇宙修饰: "高达在弹幕缝隙中完成了规避，依靠AMBAC机动稳定姿态。"
```

---

### 机制10：语义化时间轴自适应

#### 核心理念

**不同结果需要不同的时间感。**

#### 延迟计算策略

| 结果/意图 | 时间调整 | 设计理由 |
| :--- | :--- | :--- |
| CRIT | +0.5s | 强调冲击，让玩家感受伤害的重量 |
| 精神系 Intent | +0.4s | 强调意境，营造超现实氛围 |
| DODGE | -0.3s | 强调速度，体现闪避的迅捷 |
| BEAM_MASSIVE | +0.3s | 光束照射需要持续效果 |
| AOE_BURST | +0.4s | 范围爆炸需要展示波及效果 |

#### 基础时间轴

```
标准回合时间轴：

0.0s ──┬── Action 开始
       ├── 镜头切换
       ├── 攻击动画播放
       ├── Action 文本显示
       │
1.5s ──┼── Action 结束
       │
1.5s ──┼── Reaction 开始（标准间隔）
       ├── 镜头切换
       ├── 受击/闪避动画播放
       ├── Reaction 文本显示
       ├── 伤害数字弹出
       │
3.0s ──┴── Reaction 结束

语义化调整后：
- 暴击流程: Reaction 延迟到 2.0s 开始，总时长 3.5s
- 闪避流程: Reaction 提前到 1.2s 开始，总时长 2.7s
```

#### 实现方法

```
timestamp 计算：
Action.timestamp = 0
Reaction.timestamp = base_delay(1.5s) + semantic_adjustment

其中 semantic_adjustment = Σ(结果调整, 意图调整, 环境调整)
```

### 机制11：T2 原子化动态组合 (Atomic Assembly)
**目的**：解决 T2 模板多样性不足，实现“少写模板，多变效果”。

**核心理念**：将模板从“整段话”拆解为“三个原子组件（Actions）”，并在运行时随机拼装。
*   **组件 A (起势/意图 - Intent Prep)**: 基于物理本质。*例：“锁定目标后，{attacker}...”*
*   **组件 B (执行/手段 - Execution)**: 基于动作形态。*例：“...连续扣动扳机，光束扫过...”*
*   **组件 C (收招/语境 - Context Finish)**: 基于性格或结果。*例：“...精准地切开了目标的防御。”*

**拼装算法 (Assembly Algorithm)**：
1. **获取候选库**：根据 `VisualIntent` 提取子组件 A/B/C。
2. **性格/语境过滤**：使用 `Personality` 对组件 C 进行过滤。
3. **随机组合**：从 A×B×C 的笛卡尔积中随机抽取一个合法的组合。
4. **多样性增益**：若每个组件仅有 3 个变体，单一套意图可产生 **27 种不同表述**，极大地缓解了 T2 的重复感。

---

## 第七部分：生命周期与数据契约

### 7.1 四层处理生命周期（v5.0 更新）

```
[输入]
RawAttackEvent (战斗引擎输出)
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 1: 绝对律令层                                       │
│ 输入: RawAttackEvent                                       │
│ 处理: 结果路由 → 频道分配 → 逻辑纠偏                        │
│ 输出: RoutedEvent (频道标记 + 纠偏后的Result)               │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 2: 剧本解构层                                       │
│ 输入: RoutedEvent                                        │
│ 处理: 意图提取 → 双轨竞标(Action/Reaction) → 模板选择        │
│ 输出: ScriptedEvent (Action模板 + Reaction模板 + 意图标签)  │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 3: 动态丰满层                                       │
│ 输入: ScriptedEvent                                      │
│ 处理: 词缀注入 → 宿敌/羁绊查询 → 文本生成                   │
│ 输出: EnrichedEvent (丰满的Action文本 + Reaction文本)       │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 4: 视听调度层                                       │
│ 输入: EnrichedEvent                                      │
│ 处理: 镜头推导 → 降权计算 → 环境修饰 → 时间轴计算           │
│ 输出: PresentationAttackEvent (完整演出事件)                │
└─────────────────────────────────────────────────────────┘
    │
    ▼
[输出]
List[PresentationAttackEvent] (前端播放)
```

### 7.2 数据契约（扩展版）

#### RawAttackEvent

```python
@dataclass
class RawAttackEvent:
    # === 基础信息 ===
    round_number: int
    attacker_id: str
    defender_id: str
    attacker_name: str
    defender_name: str

    # === 武器信息 ===
    weapon_id: str
    weapon_name: str
    weapon_type: str           # MELEE/SHOOTING/SPECIAL
    weapon_tags: List[str]     # 新增: 武器标签 ["beam", "saber", "heavy"]

    # === 判定结果 ===
    attack_result: str         # MISS/DODGE/PARRY/BLOCK/HIT/CRIT
    damage: int
    is_lethal: bool            # 新增: HP <= 0 标记

    # === 战场状态 ===
    distance: int
    environment: str           # 新增: "surface"/"space"/"colony"
    terrain: str               # 新增: 具体地形

    # === 技能触发 ===
    triggered_skills: List[str]

    # === 机师关系 ===
    # 新增: 用于宿敌/羁绊矩阵查询
    pilot_personality: Dict[str, str]   # {"attacker": "热血", "defender": "冷静"}
```

#### PresentationAttackEvent

```python
@dataclass
class PresentationAttackEvent:
    # === 事件分类 ===
    event_type: str            # ACTION/REACTION
    round_number: int
    channel: str               # 新增: FATAL/EVADE/IMPACT

    # === 文本内容 ===
    text: str
    display_tags: List[str]    # 新增: 用于UI高亮的关键词

    # === 层级与来源 ===
    tier: str                  # T0_SCRIPTED/T1_HIGHLIGHT/T2_TACTICAL/T3_FALLBACK
    template_id: str

    # === 视听资源 ===
    anim_id: str
    camera_cam: str            # 机制7: 启发式镜头推导结果
    vfx_ids: List[str]
    sfx_ids: List[str]

    # === 时序控制 ===
    timestamp: float           # 机制10: 语义化时间轴计算结果
    duration: float            # 预计播放时长

    # === 关系标记 ===
    # 新增: 用于前端特殊表现
    rivalry_triggered: bool    # 是否触发宿敌交互
    bond_triggered: bool       # 是否触发羁绊交互

    # === 原始数据引用 ===
    raw_event: RawAttackEvent
```

---

## 第八部分：物理类定义 (Physics Intent Classes)

为保证物理还原性，意图被归类为以下四大物理类，各层级 Reaction 必须遵循其底层物理逻辑。

| 物理类 | 包含意图 | 核心物理逻辑 (Reaction Logic) |
| :--- | :--- | :--- |
| **Energy (能量)** | BEAM_*, PSYCHO_* | **熔穿与干涉**。不可被实体武器 PARRY；BLOCK 时伴随涂层蒸发特效；CRIT 时聚焦于核心熔穿。 |
| **Kinetic (实弹)** | PROJECTILE_* | **动能与爆炸**。可被机动避开或拦截（PARRY）；BLOCK 时产生冲击震颤；CRIT 时触发弹药/燃料殉爆。 |
| **Impact (撞击)** | IMPACT_*, STRIKE_* | **质量与震荡**。强调机体位移与结构形变；PARRY 会伴随巨大的关节受压声；CRIT 时损坏内部精密传感器。 |
| **Blade (切削)** | SLASH_* | **刃性与分割**。强调装甲层撕裂；PARRY 为高频火花碰撞；CRIT 时切断肢体/推进器节点。 |

---

---

## 第九部分：逻辑演进模拟 (Logic Simulation)

以“**高光反击**”场景为例，展示数据在流水线中的状态演变：

1. **Input**: `RawAttack` (Weapon=Beam, Result=CRIT, Attacker=Ace, Defender=Boss)
2. **Layer 1 (Absolute)**: 判定为致命一击？NO -> 分配至 **IMPACT** 频道。纠偏正常。
3. **Layer 2 (Scripting)**: 
    *   Action: 抽取“高能照射”意图模板。
    *   Reaction: 抽取“外甲熔融”反应模板。
4. **Layer 3 (Dynamic)**: 
    *   注入性格词缀：[Ace/Cool] -> "冷静地"。
    *   检测到 Boss 身份 -> 注入“宿命对手”专属挑衅台词。
5. **Layer 4 (AV)**: 
    *   推导镜头：`cam_shake_heavy`。
    *   时间轴：调整至 1.8s（高能照射持续感）。


---

## 第十部分：后续开发逻辑与计划 (Subsequent Development Plan)

针对系统深度演进与“导演逻辑”闭环，后续开发应聚焦以下五个核心机制的精简落地，优先保证“逻辑方法”而非代码堆砌。

### 1. 机制 2：一致性纠偏与语境适配 (Context Adapter)
**核心职责**：表现层“圆谎”与预期对齐。
*   **方法论**：建立“逻辑补位”策略。当机师触发闪避类技能（如残像、NT觉醒）但引擎结算为命中时，系统强制跳转至 **Graze (擦刺/流弹)** 模板，并注入“圆谎型”补位文本，确保演出不违背数值事实的同时保留技能牌面。

### 2. 机制 7：机师互动拦截系统 (Interception)
**核心职责**：Layer 2 高优先级剧本拦截。
*   **方法论**：在竞标前插入“关系扫描”节点。命中  矩阵时，强插 T0/T1 虚拟模板截断常规流向。实施 3-5 回合的 **硬 CD (Cooldown)** 系统，强制关系对话具备稀缺性，彻底解决“经典复读”问题。

### 3. 机制 8：启发式分镜配置 (Heuristic Camera Decision)
**核心职责**：镜头由“随机播放”向“场景推导”进化。
*   **方法论**：构建分镜决策树。核心因子包括：距离 (Distance)、伤害量级 (Damage Grading)、意图类别 (Intent) 和 交互关系。通过决策算法自动推导最优 ，实现“重击必震颤、高光必缩放”的自动化分镜规范。

### 4. 机制 9：多维权重衰减与冷却 (Decay & CD)
**核心职责**：利用数学模型强制演出多样性。
*   **方法论**：在竞标池引入动态评分算法。对 **模板ID**、**同类意图**、**语义指纹** 执行多维衰减（Decay）。所有 T1 以上高光演出在触发后权重即刻归零，进入物理冷却期，由系统强制拉动其他分片内容填充，消除视觉疲劳。

### 5. 机制 10：语义化演出节奏 (Semantic Timeline)
**核心职责**：通过非线性时间轴增强“打击感”深度。
*   **方法论**：解耦 Action 与 Reaction 的硬性间隔。基于语义结果动态计算延迟量：**暴击定格 (+0.5s)**、**觉醒/精神感应减速 (+0.4s)**、**迅捷避开 (-0.3s)**。利用不规则的演出节奏产生电影级的视觉张力。


---

## 第十部分：后续开发逻辑与计划 (Subsequent Development Plan)

针对系统深度演进与“导演逻辑”闭环，后续开发应聚焦以下五个核心机制的精简落地，优先保证“逻辑方法”而非代码堆砌。

### 1. 机制 2：一致性纠偏与语境适配 (Context Adapter)
**核心职责**：表现层“圆谎”与预期对齐。
*   **方法论**：建立“逻辑补位”策略。当机师触发闪避类技能（如残像、NT觉醒）但引擎结算为命中时，系统强制跳转至 **Graze (擦刺/流弹)** 模板，并注入“圆谎型”补位文本，确保演出不违背数值事实的同时保留技能牌面。

### 2. 机制 7：机师互动拦截系统 (Interception)
**核心职责**：Layer 2 高优先级剧本拦截。
*   **方法论**：在竞标前插入“关系扫描”节点。命中 `Rivalry/Bond` 矩阵时，强插 T0/T1 虚拟模板截断常规流向。实施 3-5 回合的 **硬 CD (Cooldown)** 系统，强制关系对话具备稀缺性，彻底解决“经典复读”问题。

### 3. 机制 8：启发式分镜配置 (Heuristic Camera Decision)
**核心职责**：镜头由“随机播放”向“场景推导”进化。
*   **方法论**：构建分镜决策树。核心因子包括：距离 (Distance)、伤害量级 (Damage Grading)、意图类别 (Intent) 和 交互关系。通过决策算法自动推导最优 `cam_id`，实现“重击必震颤、高光必缩放”的自动化分镜规范。

### 4. 机制 9：多维权重衰减与冷却 (Decay & CD)
**核心职责**：利用数学模型强制演出多样性。
*   **方法论**：在竞标池引入动态评分算法。对 **模板ID**、**同类意图**、**语义指纹** 执行多维衰减（Decay）。所有 T1 以上高光演出在触发后权重即刻归零，进入物理冷却期，由系统强制拉动其他分片内容填充，消除视觉疲劳。

### 5. 机制 10：语义化演出节奏 (Semantic Timeline)
**核心职责**：通过非线性时间轴增强“打击感”深度。
*   **方法论**：解耦 Action 与 Reaction 的硬性间隔。基于语义结果动态计算延迟量：**暴击定格 (+0.5s)**、**觉醒/精神感应减速 (+0.4s)**、**迅捷避开 (-0.3s)**。利用不规则的演出节奏产生电影级的视觉张力。

