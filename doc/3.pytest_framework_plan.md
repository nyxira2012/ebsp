# Pytest 测试指南

> **核心原则**：不做过度设计。测试是为了保证"改动代码时游戏别崩"，而不是为了刷覆盖率。
>
> **适用场景**：回合制策略游戏的 Python 后端测试

---

## 1. 目录结构与命名规范

保持扁平，方便 AI 和人类查找文件。

```
tests/
├── conftest.py            # 【核心】所有通用的 Mock 数据（机体、驾驶员、武器）都在这
├── test_core_models.py    # 测数据结构 (Pilot, Mecha)
├── test_core_combat.py    # 测核心公式 (命中、伤害计算)
├── test_skill_effects.py  # 测技能效果 (Buff, Debuff)
├── test_game_flow.py      # 测完整流程 (集成测试)
└── pytest.ini             # 配置文件
```

**命名规则**：
- 文件：`test_<模块>_<场景>.py`
- 函数：`test_<行为>_<预期结果>`（例如 `test_attack_hit_should_reduce_hp`）

---

## 2. 关键测试策略（给 AI 的指令）

当要求 AI 写测试时，强调以下三点：

### 2.1 必须 Mock 随机性（RNG）

回合制游戏充满随机（命中率 80%），测试不能随机。

**指令**：
> "在这个测试中，Mock random.uniform，强制让攻击命中（或强制暴击）。"

**代码范例**：
```python
# 强制命中判定为 0.5 (如果命中率是 0.8，则 0.5 < 0.8，必中)
with patch('src.combat.resolver.random.uniform', return_value=0.5):
    result = resolver.resolve_attack(...)
    assert result.is_hit is True
```

### 2.2 复用 Fixtures，禁止硬编码

不要在测试函数里手写 `Mecha(hp=100)`。

**指令**：
> "使用 conftest 中的 basic_mecha 和 target_mecha，不要自己实例化对象。"

**常用 Fixtures**（在 conftest.py 中维护）：
- `basic_pilot` - 白板驾驶员
- `basic_mecha` - 标准机体
- `low_hp_mecha` - 残血状态，测底力技能
- `high_will_mecha` - 高气力状态，测大招

### 2.3 关注"数值变化"和"状态流转"

**指令**：
> "验证攻击后，攻击方 EN 减少，防守方 HP 减少且气力增加。"

---

## 3. 测试分层路线图（中长期规划）

作为新手，不要试图一口气写完所有测试。按以下阶段进行：

### 阶段一：核心算子（优先保命）

**目标**：确保伤害公式、命中公式不出错。

**AI 任务**：
- "写一个参数化测试，验证距离修正公式：在 1格、3格、5格 时，命中率衰减是否符合预期。"
- "测试伤害公式：当气力 150 vs 100 时，最终伤害是否正确加成。"

### 阶段二：技能效果（最容易出 Bug）

**目标**：确保几百个技能（精神指令、被动）生效。

**AI 任务**：
- "创建一个测试：当机体拥有 '底力 L9' 且 HP < 10% 时，防御力是否 x 1.5。"
- "测试精神指令 '必中'：即使对方回避率 100%，攻击也必须命中。"

### 阶段三：游戏循环（集成测试）

**目标**：跑通一个回合。

**AI 任务**：
- "编写一个集成测试 test_full_turn：玩家移动 -> 攻击 -> 敌方反击 -> 结算。验证双方最终 HP/EN 变化。"

---

## 4. 遇到 Bug 时的处理流程

1. **复现**：让 AI 写一个最小的测试用例来重现这个 Bug（此时测试应该 Fail）
2. **修复**：修改代码，直到测试 Pass
3. **保留**：这个测试就变成了"回归测试"，永久留在项目里

---

## 5. 更好的建议：如何使用这份文档？

你现在的身份是架构师，AI 是你的打工仔。

### 建立 conftest.py 是当务之急

不要让 AI 每次写测试都瞎编数据。你先花时间让 AI 帮你生成一个完美的 `conftest.py`，里面包含"高攻低防机体"、"高闪避机体"、"残血状态"等常用预设。

### 使用 "Context Prompt"

每次让 AI 写代码时，如果涉及逻辑修改，加上这句话：
> "修改完代码后，请根据 @TESTING_GUIDE.md 的规则，为这次修改编写对应的 Pytest 单元测试，特别是要 Mock 掉随机数。"

### 不要追求 100% 覆盖率

对于 UI 显示、配置加载、日志记录，完全不用测。
**只测战斗逻辑和技能数值**。这才是回合制游戏的命脉。
