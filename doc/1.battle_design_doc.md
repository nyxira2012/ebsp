# 游戏设计文档 (Game Design Document)

## 1. 核心战斗框架 (Core Combat Framework)
整个战斗分为，计算先攻顺序，计算命中与否，计算命中后伤害数值。设计目的是为了让参与玩家尽可能全面的发展各类属性、尽可能多获得武器和机体、尽可能多获得各类物品，从而享受通过配装在随机战斗中获取胜利。

### 1.1 战斗综述
战斗采用 **1v1 回合制**。
*   **胜利条件**: 
    *   **KO (Knock Out)**: 对方机体耐久 (HP) 归零。
    *   **判定胜 (Decision)**: 若到达回合上限（4回合），剩余 HP 百分比（`当前HP / 最大HP`）更高的一方获胜。
*   **回合结构**: 先攻方行动 -> 后攻方行动 -> 回合结算。
*   **核心资源**: **气力 (Will)**。它不仅反映驾驶员战意和机体性能发挥度，还作为伤害和防御的修正系数，并影响下一回合的先手权。
*   **攻防平衡**: 攻击方拥有 **精准** 属性，可按比例削减防御方的躲闪、招架与格挡率；双方均需通过装备和成长积累攻防维度属性，防止极端偏科。


### 1.2 单回合流程
1.  **先手判定阶段**: 确定本回合谁是"先攻方"（mecha_a/mecha_b中当前发起攻击的一侧），谁是"后攻方"。
2.  **攻击自检**: 检查双方当前 EN 是否满足武器消耗。若 `当前 EN < 武器消耗`，该方本回合将 **无法发动反击/攻击**。
3.  **先攻方**执行 [攻击] + **后攻方**执行[防御] (若后攻方满足攻击条件，则为反击)。
4.  **后攻方**执行 [攻击] + **先攻方**执行[防御] (同上)。
5.  **结算阶段**:
    *   计算伤害与状态效果。
    *   **气力结算**: 计算本回合双方气力的增减变动。
    *   **气力演变**: 气力作为常驻状态持续影响整场战斗（含特定情况下的衰减）。

**命名约定**：在代码和文档中，使用 `mecha_a` 和 `mecha_b` 表示战斗中的两侧机体。这是位置性命名，不固定表示攻击方或防御方——攻防角色会在战斗中互换。具体谁是当前攻击方/防御方由战斗流程动态决定。

---

## 2. 先手判定逻辑 (Initiative System)

先手权不再仅仅是敏捷属性的比拼，而是一个分层的动态计算过程。

### 第一层：绝对优先权 (Priority Override)
*   **强制换手机制 (Overconfidence Debuff)**:
    *   若同一方连续 **2 个回合** 担任“先攻方”，则由于“轻敌”心态，第 3 个回合将 **强制触发** 换手，由另一方先攻。
    *   该机制具有持续性：只要任何一方达成连先 2 回合，下一回合必强制切换。
*   检查双方是否触发“优先先手条件”（例如：机体特殊技能“超频反应”、战场突发事件“偷袭”）。
*   **逻辑**:
    *   若触发强制换手 -> 强制确定先手归属。
    *   若无强制换手，仅一方触发特殊技能 -> 该方直接先手。
    *   若无触发或双方同时触发 -> 进入第二层判断。


### 第二层：综合优势判定 (Standard Calculation)
当无绝对优先权时，通过计算由三个维度构成的 **判定值 (Score)** 来决定。

#### A. 核心基底 (Base Score)
*   公式: `基底 = (机体性能 * 权重A) + (驾驶员感知 * 权重B)`
*   *设计意图*: 硬件和驾驶员素质是决定性因素，占高权重。

#### B. 局势修正 (Situational Modifiers)
计算两个修正项：
1.  **当前气力 (Current Will)**: 当前自身气力值对判定带来的正向修正（中等权重）。
2.  **随机事件 (Random Event)**: 战场环境的随机扰动（低权重）。

#### C. 分层判定算法 (The Logic)
计算双方基底差距 `Delta = Abs(基底A - 基底B)`。

*   **情况 1: 势均力敌 (Delta < 阈值)**
    *   *机制*: 降低“随机事件”的权重，极大提高“当前气力”的权重。
    *   *目的*: 此时比拼的是谁的战意更高。若气力也持平，则给予“上回合后手方”优先权（动态平衡）。

*   **情况 2: 实力悬殊 (Delta >= 阈值)**
    *   *机制*:
        *   **弱势方的反超机会**: 若弱势方的“当前气力”远高于强势方（通过前期防御积攒），可以获得额外的 **加成系数** 来抵消基底差距。
        *   **强势方限制**: 强势方的基底优势计算设有 **软上限 (Soft Cap)**，防止因机体性能过强导致无脑连胜。

---

## 3. 气力系统 (Will System)

“气力”是贯穿战斗全局的核心战意资源，直接影响机体性能。

### 3.1 气力范围与初始值 (Values)
*   **初始值**: 战斗开始时默认为 **100**。
*   **范围**: 基础上限为 **150**，下限为 **50**。
*   **特殊爆发**: 部分技能或零件可将上限扩展至 **170** 或 **200**（如“气力突破”）。

### 3.2 气力变动来源 (Acquisition & Loss)
气力在每回合攻击结算后实时更新：
*   **基础收益**: 每回合结束时，全员气力 **+1**。
*   **进攻加成**:
    *   攻击命中: 攻击方 **+2**，防御方 **+1**。
    *   暴击命中: 攻击方 **+5**。
    *   攻击被躲闪: 攻击方 **-1**，防御方 **+5**。
*   **防御反馈**:
    *   触发招架: 防御方 **+15**。
    *   触发格挡: 防御方 **+5**。
*   **击破收益**: 击败敌方或使其强制撤退，获得大量气力奖励（针对多机体战设计）。

### 3.3 气力影响公式 (Application)

#### A. 伤害修正 (Damage Modifier)
气力越高，对敌方的压制力越强。
`伤害修正系数 = 气力 / 100`

#### B. 防御修正 (Defense Modifier)
气力越高，驾驶员能越好地发挥装甲性能。核心公式统一为：
`有效装甲值 = (机体基础装甲 + 驾驶员守备*1.5) * (当前气力 / 100)`

#### C. 命中/躲闪微调 (Stability Bonus)
不再提供命中补正。仅提供小幅的躲闪稳定性补正：
`躲闪附加率 = (气力 - 100) * 0.2%` (即 150 气力时提供额外 10% 补正)。

---

## 4. 战斗判定：圆桌理论 (Combat Resolution: Attack Table)

核心逻辑采取 **单一随机数判定 (One-Roll System)**。系统生成一个 0-100 的随机数，按照优先级顺序落在“圆桌”的某个区间内。

### 4.1 优先级与判定区间
优先级由高到低排列（高优先级优先占据圆桌容量，若总和超过 100%，低优先级项被挤出）：

*   **计算公式**: `实际防御概率 = 基础概率 - (攻击方精准值 * 权重)` (具体权重见下文)
*   *精准作用*: 攻击方的“精准”属性越高，防御方在圆桌中的躲闪、招架、格挡区间就越窄。
    - **1 点精准值** 降低目标 **0.66%** 躲闪率。
    - **1 点精准值** 降低目标 **0.66%** 招架率。
    - **1 点精准值** 降低目标 **0.33%** 格挡率。
    - *注*: 各项概率默认值由 `config.py` 设定，计算后的上限值（招架 50%，格挡 80%）依然有效。

1.  **未命中 (Miss)**: 攻击彻底落空。（默认值为12%）
    *   *公式*: `实际未命中率 = Max(0, 12% - 攻击方命中加成)`
    *   *结果*: 0 伤害。
    *   *气力变动*: 无。
2.  **躲闪 (Dodge)**: 攻击被完全规避。（默认值为22%，受精准削减，最低可为0%）
    *   *结果*: 0 伤害。
    *   *气力变动*: **格挡方气力增加** (如 +5)。
    *   **战术效果**: 若格挡方此时处于 **EN 不足无法攻击** 状态，则触发 **[战术脱离]**。
  
3.  **招架 (Parry)**: 攻击被武器招架。（默认值为15%，受精准削减，最高可为50%）
    *   *结果*: 0 伤害。
    *   *气力变动*: **招架方气力增加** (如 +20)。
    *   **战术效果**: 若招架方此时处于 **EN 不足无法攻击** 状态，则触发 **[战术脱离]**。
4.  **格挡 (Block)**: 攻击被盾牌/护甲阻挡。（默认值为20%，受精准削减，最高可为80%）
    *   *结果*: 伤害减少 (减伤值 = 格挡值)。
 

5.  **暴击 (Crit)**: 命中要害。（默认值为25%，通过攻击方暴击加成，上限100%）
    *   *结果*: 造成 **1.5 倍** 基础伤害。
    *   *气力变动*: 无 (暴击本身即是奖励)。
6.  **普通命中 (Hit)**: 剩余概率区间。
    *   *结果*: 造成基础 100% 伤害。
    *   *优势变动*: 无。

### 4.2 伤害计算 (Damage Calculation)

当判定为 **命中 (Hit)** 或 **暴击 (Crit)** 时，进入伤害计算流程。

#### A. 基础伤害公式
*   `初始伤害 = 武器伤害 + (机体性能 * 强度系数)`
*   `暴击修正`: 若判定为暴击，初始伤害 x 1.5 

#### B. 护甲减免 (Armor Mitigation)
采用 **非线性减伤公式** (参考 WoW 机制)，确保护甲收益递减但“有效生命值 (EHP)”呈线性增长。

*   **公式**: `减伤百分比 = 护甲值 / (护甲值 + K)`
    *   *K*: 常数系数 (例如设置为 50 或 100，根据游戏数值膨胀程度调整)。
    *   *示例*: 若 K=100，护甲=100 时减伤 50%；护甲=300 时减伤 75%。

#### C. 最终伤害
`最终伤害 = 初始伤害 * (1 - 减伤百分比) - 格挡值(若触发格挡)`

---

### 4.3 熟练度系统 (Proficiency System)

熟练度是角色成长的长期积累，线性影响圆桌概率的“基准值”。

#### A. 武器熟练度 (Weapon Proficiency)
*   影响项: **未命中率 (Miss Rate)**
*   **机制**:
    *   熟练度 = 该武器累计使用次数。
    *   **阈值**: 1000 次。
    *   **惩罚**: 若熟练度 < 1000，未命中率增加（**先慢后快**特性）。
        *   0 次: 30% 未命中 (惩罚上限)。
        *   1000 次: 12% 未命中 (达到基础值，不再随熟练度优化)。
    *   *公式*: `当前未命中率 = 12% + (18% * (1 - (Min(次数, 1000)/1000)^1.5))`
    *   说明: 使用幂函数，前期熟练度提升对未命中率改善较小，后期提升效果加速。

#### B. 机体熟练度 (Mecha Proficiency)
*   影响项: **基础闪避 (Dodge)** & **招架 (Parry)**
*   **机制**:
    *   熟练度 = 该机体累计出战次数。
    *   **阈值**: 4000 次。
    *   **解锁**: 熟练度 < 4000 时，闪避和招架率按对数增长（**先快后慢**特性），初期快速提升，后期收益递减。
        *   0 次: 0% 闪避 / 0% 招架。
        *   4000 次: 22% 闪避 / 15% 招架 (达到完全体性能)。
    *   *公式*: `当前比率 = 基础比率 * (log(Min(次数, 4000) + 1) / log(4000 + 1))`
    *   说明: 使用对数函数，前期少量出战次数即可获得大部分闪避和招架加成，后期提升逐渐放缓。

---

## 5. 战场环境：交战距离 (Combat Range)

为了体现“真实系机器人”的战场感，引入 **动态距离** 机制。战斗不仅仅是立桩输出，而是从远距离索敌到近身格斗的动态过程。

### 5.1 距离变化逻辑 (Dynamic Closing)

#### A. 距离范围（单向逼近）
*   **初始遭遇**: 双方在 **3000m - 7000m** 开始雷达接触。
*   **高速接近**: 双方机体以全速逼近，每回合距离区间整体缩进 **1500m**。
*   **死斗领域**:
    *   下限最低降至 **0m** (贴身格斗)。
    *   上限最低降至 **2000m** (近距狗斗)。
    *   当达到上限 2000m 时，战斗固定在 **0m - 2000m** 范围内进行。

#### B. 距离随机化（每回合具体取值）
*   **机制**: 每回合开始时，在上述距离范围内**随机抽取一个具体距离值**。
*   **目的**: 强制玩家全面发展三类武器，避免专精单一类型。
*   **判定**: 根据随机出的具体距离，随机选择可用武器。

**设计意图**:
- T3回合距离范围跨越格斗/射击/狙击三类武器区间
- 同样是T3，可能随机到1200m（格斗回合）或3800m（射击回合）
- 玩家无法预测，必须携带多种武器以应对所有可能性


### 5.2 武器适性 (Weapon Compatibility)
| 武器类型            | 有效距离          | 惩罚规则              | 战术定位                                                       |
| :------------------ | :---------------- | :-------------------- | :------------------------------------------------------------- |
| **格斗 (Melee)**    | **< 2000m**       | **无法使用**          | 距离举例：0-2000m 视为机动突击范围，一旦进入即可发动打击。     |
| **射击 (Shooting)** | **1000m - 6000m** | 命中 -30% (过近/过远) | 距离举例：光束步枪。泛用性强，但在极近距离 (<1000m) 难以锁定。 |
| **特殊/觉醒**       | **视具体配置**    | **视配置**            | 浮游炮或地图兵器，通常具有特定的距离覆盖区间。                 |


---

---

## 6. 属性详解 (Attribute Details)

### 6.1 机体属性 (Mecha Stats)
| 属性名                   | 代码            | 说明                                                                     |
| :----------------------- | :-------------- | :----------------------------------------------------------------------- |
| **耐久值 (HP)**          | `max_hp`        | 机体的生命值，归零则机体由于大破甚至被完全摧毁而无法战斗。               |
| **能量值 (EN)**          | `max_en`        | 机体的能量储备 (即 MP)，用于发动武器                                     |
| **命中值 (Accuracy)**    | `hit_rate`      | 基础攻击命中率修正，**仅负责减少“未命中率”**，超出的部分不产生额外收益。 |
| **精准值 (Precision)**   | `precision`     | 高级攻击修正，**直接削减目标的躲闪/招架/格挡率**，是攻坚的关键属性。     |
| **暴击值 (Crit)**        | `crit_rate`     | 攻击命中要害的概率，造成 1.5 倍或更高伤害。                              |
| **躲闪值 (Dodge)**       | `dodge_rate`    | 完全规避攻击的概率，不受伤害。                                           |
| **招架值 (Parry)**       | `parry_rate`    | 使用近战武器拨开攻击的概率（通常仅限格斗战或特定光束武器）。             |
| **格挡值 (Block)**       | `block_rate`    | 使用盾牌/护甲防御攻击的概率，触发后进行减伤计算。                        |
| **装甲防御等级 (Armor)** | `defense_level` | 机体装甲强度，用于计算伤害减免比例 (Def%)。                              |
| **特殊技能 (Traits)**    | `traits`        | 机体固有的特殊能力（如：自我修复、变形、抗光束涂层）。                   |

| 属性名                 | 代码             | 说明                                                         |
| :--------------------- | :--------------- | :----------------------------------------------------------- |
| **射击值 (Shooting)**  | `stat_shooting`  | 仅影响射击类武器的**最终伤害修正**。                         |
| **格斗值 (Melee)**     | `stat_melee`     | 仅影响格斗类武器的**最终伤害修正**。                         |
| **觉醒值 (Awakening)** | `stat_awakening` | 影响觉醒类武器的威力，同时也影响直觉回避（不影响硬件命中）。 |
| **守备值 (Defense)**   | `stat_defense`   | 参与“有效装甲”计算，增加减伤效率。                           |
| **反应值 (Reaction)**  | `stat_reaction`  | 影响机体的躲闪、招架、格挡以及决定战斗的**先攻权判定**。     |
| **技量值 (Tech)**      | `stat_tech`      | **预留属性**，目前不参与任何战斗逻辑计算，仅作配置占位。     |

| 属性名           | 代码    | 说明                                                    |
| :--------------- | :------ | :------------------------------------------------------ |
| **威力 (Power)** | `power` | 武器的基础伤害数值。                                    |
| **消耗 (Cost)**  | `cost`  | 每次攻击消耗的 EN。                                     |
| **射程 (Range)** | `range` | 武器的有效距离区间，不满足则无法攻击。                  |
| **气力需求**     | `will`  | 使用该武器必须达到的气力门槛（如：必杀技需 130 气力）。 |

## 7. 结局判定与结算 (Conclusion & Rewards)

### 7.1 结局类型
| 类型                       | 触发条件                     | 结果描述                                |
| :------------------------- | :--------------------------- | :-------------------------------------- |
| **击破 (KO)**              | 敌方 HP 归零                 | 完美胜利，获得全额经验与物资奖励。      |
| **判定胜 (Decision Win)**  | 4回合结束，我方 HP% > 敌方   | 战术胜利，获得基础奖励。                |
| **战术脱离 (Withdrawal)**  | **EN 不足且成功防御**        | 战斗强行中止，按当前 HP% 比例结算胜负。 |
| **判定负 (Decision Loss)** | 4回合结束，我方 HP% < 敌方   | 战术失败，奖励大幅衰减。                |
| **平局 (Draw)**            | 4回合结束，双方 HP% 完全一致 | 双方各自撤退，获得少量安慰奖励。        |

### 7.2 强行中断
*   **损毁**: 若玩家机体 HP 归零，战斗立即中止，玩家将损失本场战斗的所有非保底收益。

---

## 9. 技能系统 (Skill System)

技能系统是战斗中打破常规逻辑、提供变数的核心。所有技能最终都映射到代码底层的 **钩子 (Hooks)** 上。

### 9.1 技能分类
1.  **系统控制 (System Control)**: 战场环境或回合强制逻辑（如：第3回合强制先攻、EMP导致电子干扰）。
2.  **驾驶员特技 (Pilot Skills)**: 驾驶员与副驾驶的个人特质（如：底力、命中补正、觉醒攻击）。
3.  **机体/武器特性 (Mecha/Weapon Traits)**: 硬件固有性能或特殊模块（如：I-Field立场、武器过载、自修复装甲）。

### 9.2 钩子机制 (Hook Mechanism)

#### A. 数值型占位符 (Numeric Hooks)
用于直接在公式中进行加减或乘法修正。默认值通常为 `0` 或 `1.0`。

| 钩子代码           | 描述              | 默认值 | 示例技能              |
| :----------------- | :---------------- | :----- | :-------------------- |
| `HOOK_HIT_ADD`     | 最终命中率加成    | `0%`   | 专注 (+15%)           |
| `HOOK_EVA_ADD`     | 最终躲闪率加成    | `0%`   | 直感 (+20%)           |
| `HOOK_DMG_MUL`     | 最终伤害乘数      | `1.0`  | 热血 (x2.0)           |
| `HOOK_DEF_MUL`     | 最终减伤乘数      | `1.0`  | 铁壁 (x0.5)           |
| `HOOK_WILL_ADD`    | 额外气力获取量    | `0`    | 斗争心 (+10 初始气力) |
| `HOOK_EN_COST_MUL` | 燃料/能量消耗系数 | `1.0`  | 节约 (x0.8)           |

#### B. 机制型占位符 (Logic Flags)
用于改变代码的条件判断分支。默认为 `False`。

| 钩子代码                    | 描述                       | 默认值  | 示例技能 |
| :-------------------------- | :------------------------- | :------ | :------- |
| `HOOK_FORCE_INITIATIVE`     | 本回合强制先攻             | `False` | 先制攻击 |
| `HOOK_IGNORE_ARMOR`         | 伤害计算时无视护甲         | `False` | 破甲弹   |
| `HOOK_GUARANTEE_PARRY`      | 必定触发招架 (若距离允许)  | `False` | 剑豪     |
| `HOOK_IGNORE_RANGE_PENALTY` | 无视武器距离带来的命中惩罚 | `False` | 精准射击 |
| `HOOK_SUPPRESS_ESCAPE`      | 阻止敌方触发战术脱离       | `False` | 锁定追踪 |
| `HOOK_DEATH_RESIST`         | 免除一次致死伤害 (HP留1)   | `False` | 不屈     |

---

## 10. 数据结构预览 (Schema Preview)
