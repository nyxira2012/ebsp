# 机体属性与装备系统设计文档 v1.5

## 1. 系统概述
本模块负责将静态的机体数据、驾驶员数据、装备数据以及养成进度（改造），聚合为战斗系统可直接使用的**结构化快照 (Snapshot)**。
战斗模块（Battle Core）**仅读取** Snapshot 数据，不直接依赖底层养成逻辑，实现“养成”与“战斗”的解耦。

## 1.1 设计原则
1.  **纯加法叠加**: `最终值 = 初始值 + 改造值 + 装备加成 + 驾驶员修正 + 技能修正`。
2.  **全局乘系数**: 预留 `global_mul_eff` (默认 1.0) 用于处理战场光环或特殊状态的整体缩放。
3.  **快照机制**: 双重用途 (Dual Purpose)：
    - UI 展示 (Preview Mode): 后端立即计算并返回 MechaSnapshot 供前端渲染。
    - 战斗输入 (Runtime Mode): 进入战斗时的核心数值基础。
4.  **数据安全**: 采用 **Pydantic (v2)** 进行模型定义与验证。
5.  **命名规范**: 严禁使用 `base_` 开头的属性名。统一使用 `init_` 表示初始值。

---

## 2. 养成与装备系统

### 2.1 改造与槽位
-   **改造系统**: 0-10 段基础改造（HP, EN, 装甲, 机动等机体属性）。
-   **槽位系统**: 
    -   **FIXED**: 固定部位，可为武器或设备。
    -   **WEAPON**: 武器位。
    -   **EQUIP**: 设备位（强化部件）。

### 2.2 驾驶员系统 (Main & Sub Pilot)
-   **主驾驶**: 核心属性、特技来源，以及武器威力的主要加成来源。
-   **副驾驶**: **视为一种特殊的“虚拟装备”**，通过配置提供固定属性增量（加法）与额外技能，不提供五维属性对武器威力的乘法修正。
-   **立绘管理**: 各持有独立的 `portrait_id` 资源字段。

---

## 3. 源数据模型 (Source Data Definitions)

### 3.1 机体静态配置 (MechaConfig)
```python
from pydantic import BaseModel
from typing import List

class MechaConfig(BaseModel):
    id: str
    name: str
    portrait_id: str
    model_asset: str
    
    # 基础属性 (Level 0)
    init_hp: int
    init_en: int
    init_armor: int
    init_mobility: int
    
    # 判定属性 (硬件修正)
    init_hit: float         # 命中率修正
    init_precision: float   # 精准值
    init_crit: float        # 暴击率
    
    # 防御倾向
    init_dodge: float       # 机体回避
    init_parry: float       # 机体招架
    init_block: float       # 机体格挡
    init_block_red: int     # 机体格挡减伤
    
    # 槽位与武器
    slots: List[str]        # ["WEAPON", "EQUIP"...]
    fixed_weapons: List[str]# 内置武器 ID 列表
```

### 3.2 装备/部件配置 (EquipmentConfig)
```python
from pydantic import BaseModel
from typing import List, Dict, Optional

class EquipmentConfig(BaseModel):
    id: str
    name: str
    type: str               # WEAPON / EQUIP
    
    # 属性修正
    stat_modifiers: Dict[str, float] = {}
    
    # 武器特有属性
    weapon_power: Optional[int] = None
    weapon_range_min: Optional[int] = None
    weapon_range_max: Optional[int] = None
    weapon_en_cost: Optional[int] = None
    weapon_type: Optional[str] = None # SHOOTING, MELEE, AWAKENING, SPECIAL
    weapon_tags: List[str] = []
    weapon_anim_id: str = "default_anim" # 战斗动画预留
    
    # 携带技能
    passive_skills: List[str] = []
```

### 3.3 驾驶员配置 (PilotConfig)
```python
class PilotConfig(BaseModel):
    id: str
    name: str
    portrait_id: str

    # 核心五维
    stat_shooting: int      # 射击
    stat_melee: int         # 格斗
    stat_awakening: int     # 觉醒
    stat_defense: int       # 守备
    stat_reaction: int      # 反应
    stat_tech: int = 0      # 技量 (预留配置，暂不参与计算)

    # 熟练度系统 (Proficiency System)
    weapon_proficiency: int = 500     # 武器熟练度 (影响命中惩罚)
    mecha_proficiency: int = 2000     # 机体熟练度 (影响防御率)

    innate_skills: List[str] = []
```

**熟练度系统说明**：
熟练度是驾驶员成长的长期积累，线性影响圆桌概率的"基准值"。

- **武器熟练度 (Weapon Proficiency)**
  - 影响项：未命中率 (Miss Rate)
  - 机制：熟练度为该武器累计使用次数，阈值为 1000 次
  - 惩罚公式：若熟练度 < 1000，未命中率增加（先慢后快特性）
    - 0 次：30% 未命中（惩罚上限）
    - 1000 次：12% 未命中（达到基础值）
    - 公式：`当前未命中率 = 12% + (18% * (1 - (Min(次数, 1000)/1000)^1.5))`

- **机体熟练度 (Mecha Proficiency)**
  - 影响项：基础闪避 (Dodge) & 招架 (Parry)
  - 机制：熟练度为该机体累计出战次数，阈值为 4000 次
  - 解锁公式：熟练度 < 4000 时，闪避和招架率按对数增长（先快后慢特性）
    - 0 次：0% 闪避 / 0% 招架
    - 4000 次：22% 闪避 / 15% 招架（达到完全体性能）
    - 公式：`当前比率 = 基础比率 * (log(Min(次数, 4000) + 1) / log(4000 + 1))`

---

## 4. 属性聚合管线 (Calculation Pipeline)

### 4.1 属性加算逻辑
**`Aggregate_Stat = (init_stat + Upgrade + Equipment + SubPilot_Fix)`**
**`Final_Stat = Aggregate_Stat * global_mul_eff`**

- **加算顺序**: 改造值、装备加成、副驾驶修正均为平级加法，无先后顺序依赖。
- **命中修正 (Final_Hit)**: **仅由硬件（机体+设备）决定**，主驾驶五维属性不计入命中判定。
- **精准削减逻辑**:
    - 最终躲闪率 = 机体最终躲闪 - (精准值 * 0.66)
    - 最终招架率 = 机体最终招架 - (精准值 * 0.66)
    - 最终格挡率 = 机体最终格挡 - (精准值 * 0.33)
- **气力影响**:
    - **伤害修正**: 伤害修正系数 = 气力 / 100
    - **防御修正**: 有效装甲 = (装甲 + 守备×1.5) × (气力 / 100)
    - **躲闪稳定性**: 仅提供小幅躲闪附加率 = (气力 - 100) × 0.2%（150气力时额外+10%）
    - **注意**: 气力**不再提供命中补正**

### 4.2 武器威力补正逻辑
武器最终威力由 **Base_Power * (1 + Pilot_Stat / 200)** 确定。
- **射击 (SHOOTING)**: 使用 `stat_shooting`。
- **格斗 (MELEE)**: 使用 `stat_melee`。
- **觉醒 (AWAKENING)**: 使用 `stat_awakening`。
- **特殊 (SPECIAL)**: **自动取上述三项中的最高值**。

---

## 5. 快照数据结构 (Snapshot Schema)

```python
from pydantic import BaseModel, ConfigDict
from typing import List, Optional, Dict

class WeaponSnapshot(BaseModel):
    uid: str
    definition_id: str
    name: str
    type: str
    
    final_power: int            # 加成后的实战威力
    range_min: int
    range_max: int
    en_cost: int                # 统一使用 EN 消耗
    anim_id: str                # 战斗动画 ID
    
    # 额外补正
    hit_mod: float
    crit_mod: float
    will_req: int
    tags: List[str] = []

class MechaSnapshot(BaseModel):
    instance_id: str
    mecha_name: str
    
    # 资源管理
    main_portrait: str
    sub_portrait: Optional[str] = None
    model_asset: str
    
    # 核心状态
    final_max_hp: int
    current_hp: int
    final_max_en: int
    current_en: int
    
    # 战斗属性
    final_armor: int
    final_mobility: int         # 含反应修正
    block_reduction: int
    
    # 判定倾向 (0-100)
    final_hit: float
    final_precision: float
    final_crit: float
    final_dodge: float
    final_parry: float
    final_block: float
    
    weapons: List[WeaponSnapshot]
    skills: List[str] 
    pilot_stats_backup: Dict[str, int]
```

---

## 6. 核心逻辑规范总结
1.  **资源消耗**: 废除武器弹药，**所有武器统一消耗 EN**。
2.  **威力加成**: 驾驶员属性仅修正威力，不修正命中。严格遵循射击/格斗/觉醒分类。
3.  **动画支持**: 来源配置中的 `weapon_anim_id` 必须传递至快照的 `anim_id`。
4.  **技量预留**: 驾驶员 `stat_tech` 属性存在于模型中，但目前不影响任何战斗判定。
5.  **全局系数示例 (`global_mul_eff`)**:
    - **全员激励**: 活动开启时，所有参战机体 `global_mul_eff = 1.1`（全属性及伤害提升 10%）。
    - **随机 Buff**: 战场随机事件触发“过载”，该回合 `global_mul_eff = 1.25`。
6.  **有效防御力**: 核心公式 `(final_armor + stat_defense * 1.5) * (will / 100)` 用于减伤百分比计算。
7.  **武器气力需求**: 只有当 `MechaSnapshot.current_will >= WeaponSnapshot.will_req` 时，该武器才出现在可用列表。
