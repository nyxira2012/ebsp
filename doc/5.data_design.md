# EBSB 数值平衡核心度量：EHP与iLevel实现细则（轻量版）
**版本**：v2.0 | **状态**：详细设计 | **领域**：数值框架/属性价值定标
**适用范围**：小型个人Web游戏项目（≤20玩家）

---

## 1. 引言

本细则在现有数据模型（机体/装备/驾驶员静态配置、属性聚合管线）基础上，将**有效生命（EHP）**与**物品等级（iLevel）**两大度量落地为可计算、可验证的工程模块。

**目标**：
- 为每一台机体、每一个装备、每一位驾驶员输出**统一强度标尺**，消除"凭感觉调数值"。
- 建立**属性货币化体系**，使任何数值投放都能用**EP（属性点）**计价。
- 提供**简单实用的评估工具**，辅助手工调整平衡。

**小项目原则**：
- ✅ 简单可用的计算公式
- ✅ 手工调整的权重配置
- ✅ 基础的数据评估脚本
- ❌ 不需要复杂的自动化系统
- ❌ 不需要实时监控告警
- ❌ 不需要版本管理回滚  

---

## 2. 有效生命（EHP）详细计算模型  

EHP定义为**在标准攻击者持续攻击下，防御方能承受的预期总原始伤害量**。  
EBSB战斗流程决定了EHP需逐层折算：**名义HP ÷ [综合被命中率 × 综合免伤率 × 护甲减伤]**。  

### 2.1 标准攻击者定义（用于EHP定标）  

| 参数 | 设定值 | 说明 |
|------|--------|------|
| 命中率基础值 | 90% | 未受精准削减免影响前的初始命中率 |
| 精准值 | 20 | 用于削减防御方闪避/招架/格挡（基准值） |
| 武器威力 | 1000 | 用于DPR计算，EHP不直接依赖武器威力 |
| 驾驶员攻击属性 | 200 | 影响武器威力系数（DPR用） |
| 暴击率 | 10% | 用于EHP的暴击期望增伤计算 |
| 暴击伤害倍率 | 150% | 固定值 |
| 格挡减伤率 | 40% | 防御方格挡成功时减免比例（若无特殊技能） |

*此标准攻击者不是战斗实体，而是EHP计算的“量尺”，所有EHP均在此攻击者下测得，保证横向可比性。*  

### 2.2 EHP计算公式（全展开）  

```
EHP = HP ÷ [ Hit_Rate_After_All × (1 - Block_Eff) × (1 + Crit_Eff) × (1 - Armor_DR) ]
```

#### 2.2.1 各因子定义及数据来源  

**① 名义生命值 HP**  
- 来自 `MechaSnapshot.armor + MechaSnapshot.structure`（快照已聚合改造/装备/驾驶员加成）  

**② 综合被命中率 Hit_Rate_After_All**  

```
Hit_Rate_After_All = min( max( Base_Hit_Rate - (Dodge_Rate + Parry_Rate), 0.05 ), 0.95 )
```

其中：  
- `Base_Hit_Rate` = 标准攻击者命中率（90%）  
- `Dodge_Rate` = 防御方最终闪避率  
  ```
  Dodge_Rate = (MechaSnapshot.dodge + 气力附加闪避) × 熟练度修正  
  气力附加闪避 = (MechaSnapshot.morale - 100) × 0.002  
  熟练度修正 = log(机体熟练度+1) / log(4001)  （满熟练度时为1）
  ```
- `Parry_Rate` = 防御方最终招架率（计算逻辑同上，招架熟练度修正与闪避共用同一系数）  

**精准削减**（重要）：标准攻击者拥有基准精准值（20），会按比例抵消防御方闪避/招架/格挡率。  
```
最终闪避率 = Dodge_Rate - (标准精准值 × 0.66)  
最终招架率 = Parry_Rate - (标准精准值 × 0.66)  
最终格挡率 = Block_Rate - (标准精准值 × 0.33)  
```
削减后各率不低于0。

**③ 格挡期望免伤率 Block_Eff**  

```
Block_Eff = 最终格挡率 × 格挡减伤比例  
格挡减伤比例 = MechaSnapshot.block_reduction / 100   （模型字段 init_block_red 单位应为数值，需除100归一化）
```

**④ 暴击期望增伤率 Crit_Eff**  

```
Crit_Eff = 标准暴击率 × (标准暴击伤害倍率 - 1)  
标准暴击率 = 10% （防御方无暴击抗性，此处暴击率完全由攻击方决定）  
```

**⑤ 护甲减伤 Armor_DR**  

采用减法公式与比例公式的折中，推荐**攻防比幂函数**：  

```
Armor_DR = 1 - ( 武器威力系数因子 )  
武器威力系数因子 = (标准武器威力 / 有效装甲) ^ 0.8  并限制在[0.2, 1.0]区间  
有效装甲 = MechaSnapshot.armor + 驾驶员守备×1.5  
最终护甲减伤 = 1 - (标准武器威力 × 1.0 / 有效装甲)^0.8  
```
此公式使得防御收益递减，且与DPR计算中的武器威力系数对称。  

#### 2.2.2 分类型EHP  

由于武器存在物理/光束等属性，且防御方对不同类型可能有不同抗性（通过装备技能实现），**EHP应分类型计算**：  

```
EHP_type = HP ÷ [ Hit_Rate_All × (1 - Block_Eff) × (1 + Crit_Eff) × (1 - Armor_DR_type) ]
```
- `Armor_DR_type` 根据防御方对特定伤害类型的抗性修正装甲值或直接修正减伤率。  
- 综合EHP取各类型加权平均，权重为预设环境伤害类型分布（初期可均等）。  

---

## 3. 回合期望伤害（DPR）计算模型  

EHP衡量生存，DPR衡量输出，两者共同构成配置强度评价的**两大支柱**。  

**DPR定义**：在标准防御者攻击下，攻击方每回合期望造成的最终伤害。  

### 3.1 标准防御者定义  

| 参数 | 设定值 | 说明 |
|------|--------|------|
| 闪避率 | 10% | 未受精准削减免 |
| 招架率 | 5% | |
| 格挡率 | 5% | |
| 格挡减伤 | 40% | |
| 护甲 | 1000 | 基准值 |
| 守备 | 100 | 驾驶员守备影响有效装甲 |

此标准防御者用于DPR定标，所有DPR均在此目标下测得。

### 3.2 DPR计算公式  

**单次攻击期望伤害** =  
```
武器威力 × (1 + 对应驾驶员属性/200) × 命中期望因子 × 暴击期望因子 × 护甲减伤倒数
```

**每回合攻击次数**：默认1次（若存在多重攻击技能，单独处理）。  

#### 3.2.1 因子展开  

**① 武器威力**  
取自 `EquipmentSnapshot.weapon_power`（已含改造/装备加成）  

**② 驾驶员属性系数**  
武器类型决定使用 `stat_shooting` / `stat_melee` / `stat_awakening`，特殊类型取三者最高。  

**③ 命中期望因子**  
```
命中率 = min( max( 90% - (标准防御者闪避率 + 招架率) + 攻击方命中率修正, 0.05 ), 0.95 )  
```
攻击方命中率修正取自 `MechaSnapshot.hit`（机体+装备，驾驶员不贡献）。  

**④ 暴击期望因子**  
```
暴击率 = 攻击方最终暴击率 - 标准防御者暴击抗性（默认0）  
暴击期望因子 = 1 + 暴击率 × (暴击伤害倍率 - 1)  
```
暴击伤害倍率默认150%，可通过技能提升。  

**⑤ 护甲减伤倒数**  
```
护甲减伤 = ( 攻击方武器威力 × 1.0 / 标准防御者有效装甲 )^0.8  （上限1.0，下限0.2）  
最终伤害系数 = 1 - 护甲减伤   // 实际承受伤害比例  
DPR护甲因子 = 1 / 最终伤害系数   // 用于EHP换算时，DPR已包含伤害公式
```
实际上，DPR计算直接输出伤害数值，不需要倒数。  

**DPR = 武器威力 × (1+属性/200) × 命中率 × (1+暴击率×(暴击伤害倍率-1)) × (1 - 护甲减伤)**  

*注意：护甲减伤公式与EHP中的Armor_DR一致，但攻防角色互换。*  

---

## 4. 属性价值定标（EP权重系统）  

**核心思想**：通过EHP/DPR对属性的敏感度，将各属性统一换算为**等效攻击力**，形成EP价值表。  

### 4.1 基准单位  

定义 **1 EP = 1点武器威力** 带来的DPR提升（在标准攻防环境下）。  

### 4.2 各属性EP价值计算步骤  

1. **选取基准配置**：白板机体+无技能驾驶员+基础武器。  
2. **控制变量微调**：单独增加1单位某属性，重新计算EHP或DPR。  
3. **计算边际贡献**：  

   - **攻击类属性**（武器威力、射击/格斗/觉醒）：  
     `EP = ΔDPR / Δ属性`，再与1点武器威力基准ΔDPR归一化。  
     例：+1武器威力 → DPR+10，则1武器威力=1EP。  
     +1射击 → DPR+8，则1射击=0.8EP。  

   - **防御类属性**（装甲、守备、闪避、招架、格挡、HP等）：  
     通过EHP变化折算为DPR等效。  
     `ΔEHP` → 在标准攻击者下，相当于增加多少HP，HP本身可换算为EP（HP与DPR的关系由标准攻防对决定）。  
     通常：标准攻防下，1点HP价值 = 标准武器单发伤害 / 标准HP等比例换算，实际可设定一个**HP-EP汇率**。  

4. **生成属性价值表**（示例，需实际模拟校准）：  

| 属性 | 单位 | EP价值 | 备注 |
|------|------|--------|------|
| 武器威力 | 1 | 1.0 | 基准 |
| 射击/格斗/觉醒 | 1 | 0.65 | 受武器威力系数影响 |
| 装甲 | 1 | 0.12 | 减伤收益递减 |
| 守备 | 1 | 0.18 | 守备同时提供有效装甲和气力防御 |
| 闪避率 | 1% | 2.5 | 被精准削减削弱 |
| 招架率 | 1% | 2.2 | |
| 格挡率 | 1% | 1.8 | 依赖格挡减伤率 |
| 格挡减伤 | 1% | 0.8 | |
| 命中率修正 | 1% | 2.0 | |
| 暴击率 | 1% | 2.8 | 依赖暴击伤害倍率 |
| HP | 1 | 0.05 | 名义生命值 |
| …… | | | |

**动态校准**：属性价值会随版本数值环境变化，需在每次大规模模拟后重新计算权重，并更新EP表。  

---

## 5. 物品等级（iLevel）系统实现  

### 5.1 物品等级公式  

**总物品等级 = 基础等级 + 属性总EP × 品质系数**  

- **基础等级**：代表该物品/机体/驾驶员的稀有度底值（如R=100, SR=150, SSR=200）。  
- **属性总EP**：所有提供的属性（含技能特效）按EP表换算后的总和。  
- **品质系数**：通常=1，也可对不同稀有度设置不同系数以体现档次差距。  

### 5.2 技能特效折价  

技能无法直接映射为属性，需通过**模拟测试**确定其EP价值：  

1. 构建带技能与不带技能的两个配置，除技能外其他属性完全相同。  
2. 通过蒙特卡洛模拟得到胜率提升（或DPR/EHP提升）。  
3. 将该提升换算为等效属性EP。  

**示例**：技能“20%概率追加一次50%伤害攻击” → 模拟得DPR提升8%，查EP表知8%DPR ≈ 80 EP（假设1% DPR=10EP），则技能EP价值=80。  

所有技能特效必须标定EP价值，并计入iLevel。  

### 5.3 格纳库编队限制升级  

原有Cost限制可**升级为总iLevel限制**，例如：  

```
格纳库总iLevel上限 = 5000  
每台机体iLevel = 机体基础iLevel + 装备总iLevel + 驾驶员iLevel  
```

此机制比单纯Cost更科学，直接反映配置的真实强度。  

---

## 6. 嵌入现有模拟验证流程  

### 6.1 快照扩展  

```python
class MechaSnapshot(BaseModel):
    # ... 原有字段
    eph: Dict[str, float]   # 分类型有效生命
    dpr: float              # 对标准防御者期望伤害
    item_level: int
```

快照聚合时自动调用`balance.calculator`模块计算上述值，并存入快照。  

### 6.2 蒙特卡洛模拟增强  

- **输入**：配置对，同时传入双方的EHP、DPR、iLevel。  
- **输出**：除了胜率，新增**EHP残差**、**DPR残差**等诊断指标。  
- **残差分析**：若某配置实际胜率显著高于基于iLevel差/EP比预测的胜率，说明存在**未计入EP的协同效应**，需进一步拆解技能组合。  

### 6.3 平衡仪表盘指标扩展  

| 指标 | 计算公式 | 告警阈值 |
|------|--------|----------|
| 属性转化率漂移 | 当前EP/历史EP 偏差 | >20% |
| iLevel-胜率S曲线拟合优度 | R² | <0.8 |
| 极端值配置占比 | 胜率>65%或<35%的配置比例 | >10% |
| EHP/DPR帕累托边界 | 同时高于75%分位 | 标记人工审查 |

---

## 7. 实施路线图（细化）  

**迭代1：EHP/DPR计算模块**（2周）  
- 实现`EHPCalculator`类，输入快照，输出各类型EHP。  
- 实现`DPRCalculator`类，输入武器快照+驾驶员属性，输出期望伤害。  
- 单元测试：对简单属性组合验证期望值合理性。  

**迭代2：EP权重初版定标**（1周）  
- 编写`EPCalibrator`脚本，通过控制变量蒙特卡洛（10万场/属性点）计算各属性边际贡献。  
- 输出属性价值表v1，存入`config/balance/weight_v1.json`。  

**迭代3：iLevel集成与仪表盘**（2周）  
- 实现`ItemLevelCalculator`，读取属性价值表，计算机体/装备/驾驶员iLevel。  
- 修改快照生成流程，加入EHP/DPR/iLevel字段。  
- 在模拟报告中嵌入散点图矩阵。  

**迭代4：动态校准流水线**（持续）  
- 每次全量模拟后自动触发EP重标定，对比新旧权重差异，发送周报。  
- 建立版本化权重管理，支持回滚。  

---

## 8. 总结  

通过将**EHP**与**iLevel**深度植入EBSB数据模型与模拟流水线，数值平衡从“试错”转向“工程化度量”：  
- 每一张卡、每一件装备都有清晰的**强度数字标签**。  
- 每一次数值调整都可以用**EP预算**解释其合理性。  
- 每一个隐藏毒瘤搭配都能在**帕累托边界**上被迅速发现。  

**下一步**：请数值组与后端组依据迭代1任务，在`/src/balance/`下启动`eph_dpr.py`开发，并撰写`EHP_CALC.md`详细设计文档。  

---  
**附录：魔兽世界经验映射**  
- EHP公式参考WOW护甲减伤、圆桌理论，但将“攻击者等级”替换为“武器威力/装甲比”。  
- 物品等级预算制参考WOD属性压缩思想，每1%属性提升对应约0.7%物品等级增长，EBSB初期可暂按线性1:1投放。  
- 属性权重随版本浮动是MMO通性，EBSB将首次在页游类产品中实现**自动化权重校准**。