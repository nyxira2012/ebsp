# Development Log (DEVLOG.md)

---

## 2026-02-09 战斗叙事与术语体系完善

> **项目快照**：代码文件 12 个（2045 行）| 设计文档 2 个（781 行）

### 逻辑变化与核心思路

1. **战斗核心概念重构：从"优势值"到"气力系统"**
   - **逻辑变化**：将原本模糊的"优势值"概念替换为更具体的"气力"系统，这个改动贯穿整个战斗设计。
   - **设计思路**："气力"作为驾驶员战意与机体性能发挥的结合点，不仅在数值上影响伤害/防御修正，还直接决定先攻权判定。相比抽象的"优势"，气力能通过攻击命中、招架、格挡等具体动作实时增减，让战意积累的过程可视化、可预测。

2. **资源限制机制的引入：EN消耗与战术脱离**
   - **逻辑变化**：新增EN检查环节，在攻击判定前先确认"当前EN >= 武器消耗"，不满足则无法攻击。同时新增"战术脱离"结局——EN不足但成功防御可强制中止战斗。
   - **设计思路**：这是对传统机战游戏的致敬。武器不再是无限使用的，玩家必须管理机体能量。更关键的是，"战术脱离"给劣势方留出了体面退出的通道——即使打不过，通过精明的防御也能保住机体撤退，这比单纯的"战败"更有策略深度。

3. **圆桌判定系统的气力反馈闭环**
   - **逻辑变化**：防御类判定（躲闪/招架/格挡）现在会为防御方提供气力奖励（躲闪+5、招架+15、格挡+5），而不仅仅是"未受伤"。
   - **设计思路**：建立"防御得利"的反馈循环。弱势方即使无法反击，通过连续招架/格挡也能快速积累气力，在后续回合通过高气力反超先攻权，实现"以守为攻"的战术路线。

4. **叙事视角的动态切换机制**
   - **逻辑变化**：文字演出不再是固定的"攻击方视角"，而是根据圆桌判定结果动态选择——命中类（Miss/Hit/Crit）从攻击方描述武器威力，防御类（Dodge/Parry/Block）从防御方描述机体机动性。
   - **设计思路**：这样能最大化每个回合的信息密度。当判定为"招架"时，读者更想看到的是"防御方如何巧妙化解攻击"，而不是"攻击方打空了"。视角切换让每种判定结果都有其独特的叙事张力。

5. **术语风格的统一化与沉浸感提升**
   - **逻辑变化**：新增完整的"属性展示名称映射表"，将所有内部代码（hp、en、will等）映射为机器人动画风格的术语（机体耐久、能量出力、气力），并标注术语来源（高达UC、Franxx、机动警察等）。
   - **设计思路**：前端显示的"能量出力：45/80"比"EN：45/80"更有代入感。更关键的是，统一术语风格能让玩家快速建立认知框架——看到"NT等级"就知道是新人类相关，看到"I力场格挡"就能联想到高达的技术设定。这种细节打磨在长期游玩中会形成强烈的世界观沉浸感。

---

## 2026-02-09 战斗系统底层架构重构

> **项目快照**：代码文件 12 个（1769 行）| 设计文档 2 个（781 行）

### 逻辑变化与核心思路

1. **架构进化：从"静态属性修正"转向"流水线钩子系统"**
   - **逻辑变化**：重构了战斗计算流程。不再在初始化时将加成固定在属性上，而是引入了 `SkillRegistry` 钩子系统。命中判定、伤害计算、减伤判定等每一个核心数值环节都变成了可干预的"管道"。
   - **设计思路**：为了后续支持无限扩展的技能（如 SRW 中的"必中"、"热血"、"底力"等），必须让战斗引擎与具体的技能逻辑解耦。现在引擎不再关心有哪些技能，只需在计算时向注册表"询问"是否存在修改者。

2. **状态系统的生命周期化 (Effect & Tick Mechanism)**
   - **逻辑变化**：引入了 `EffectManager` 和有时效性的 `Effect` 模型。精神指令（Spirit Commands）现在作为带持续回合的状态存在，并在回合结束时通过 `tick_effects` 自动衰减。
   - **设计思路**：为了精确复刻机战中"仅限本回合有效"或"仅限下次攻击有效"的策略感。将"临时状态"从"机体基础性能"中彻底分离。

3. **机体特性的标准化注入 (TraitManager)**
   - **逻辑变化**：新增 `TraitManager`，专门负责机体固有特性（如"学习型计算机"、"强化装甲"）的统一点火。
   - **设计思路**：建立清晰的属性修正层级：机体基础值 -> 固有特性修正 -> 战场临时状态加成。这为未来的"二周目继承"或"机体改造"预留了干净的接口。

4. **战场上下文 (BattleContext) 的角色升级**
   - **逻辑变化**：`BattleContext` 增加了对地形（Terrain）和事件标记（Event Flags）的支持，并成为所有钩子函数的必传参数。
   - **设计思路**：逻辑不再是孤岛。通过上下文，技能可以感知当前是"我方回合"还是"敌方反击"，以及当前处于"宇宙"还是"基地"，从而实现复杂的地形相关技能或反击专用技能。

---

## 项目起始阶段小结 (2026-01-XX 至 2026-02-07)

> **项目快照**（2026-02-07 纯设计阶段）：代码文件 0 个（0 行）| 设计文档 2 个（54 行）

### 设计定型：核心战斗框架与叙事体系的建立

在2月8日进入代码实现阶段之前，项目经历了完整的设计定型期。这一阶段的核心成果是将抽象的机器人战斗概念转化为可落地的设计规范。

#### 1. 战斗核心机制的设计确立

**圆桌判定系统的提出**
- 从传统RPG的"命中/未命中"二元判定，转向更复杂的"单一随机数圆桌系统"。将Miss（12%）、Dodge（22%）、Parry（15%）、Block（20%）、Crit（25%）、Hit（剩余）按照优先级排列，让每个判定结果都有其战术价值。
- 设计思路：避免"概率堆砌"的数值膨胀，通过"精准"属性削减敌方防御区间，建立攻击与防御的博弈空间。

**动态距离机制的引入**
- 打破传统回合制战斗的"立桩对射"，设计了从3000-7000m开始、每回合缩进1500m的动态距离系统。强制玩家同时装备格斗、射击、狙击三类武器。
- 设计思路：体现真实系机器人的战场感，距离不再是一个静态标签，而是每回合随机抽取的具体数值，带来武器可用性的不确定性。

**优势值（后改为气力）系统的概念化**
- 最初提出"优势值"作为核心资源，通过攻击命中、招架格挡等动作积累，影响先攻权判定。防御方可以通过完美防守获得大量优势，实现"以守为攻"的反超路线。
- 设计思路：建立动态平衡机制，防止强势方无脑滚雪球，给弱势方留出翻盘通道。

#### 2. 叙事视角的结构化

**标准四段式演出模板**
- 提出战场环境、先手攻击、后手反击、回合总结的四段式结构，单回合字数控制在100-150字。
- 关键创新：根据圆桌判定结果动态切换叙事视角——命中类从攻击方描述武器威力，防御类从防御方描述机体机动性。最大化每回合的信息密度。

**示例驱动的文档风格**
- 通过完整的4回合战斗示例（高达VS扎古），展示从雷达接触到最终决战的全过程。让开发者能直观理解"初动-接敌-死斗-决战"的节奏变化。

#### 3. 从设计到实现的准备

这一阶段虽然没有代码，但设计文档已经明确规定了：
- 数据模型所需的字段（机体、驾驶员、武器三大类属性）
- 圆桌判定的优先级公式
- 先手权的分层判定逻辑（绝对优先权→综合优势判定）
- 文本演出的API接口格式（Environment、Action、Summary三类模板）

这些设计规范直接指导了后续的代码架构（如SkillRegistry钩子系统、BattleContext上下文对象）的设计方向。

#### 4. 设计文档的演进

从git历史可以看到，设计文档经历了三轮迭代：
- f31e6c1（战斗文档设定更新）：初步建立战斗框架
- d7f33fe（优化战斗设计和文字演出细节）：完善圆桌判定和距离机制
- afc57f2（进一步优化文字演出设计）：定型四段式叙事和视角切换逻辑

每一次迭代都在细节上打磨，为2月9日的代码实现阶段扫清了概念障碍。

---
