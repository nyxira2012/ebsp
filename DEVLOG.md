# Development Log (DEVLOG.md)

---

## 2026-02-12 技能库扩充与测试覆盖率完善

> **项目快照**：代码文件 14 个（3043 行）| 设计文档 6 个（1956 行）

### 逻辑变化与核心思路

1. **精神指令体系的全面扩展**
   - **逻辑变化**：在 `src/skills.py` 中新增了 12 个精神指令方法（梦境、威压、搅乱、奇迹、本能、激怒、气魄、努力、拖延、执念、再动），并在 `data/skills.json` 中配置了完整的 JSON 数据（+467 行）。
   - **设计思路**：补充机战经典的精神指令系统。核心区分三类指令：
     - **先手类**（梦境、威压）：通过 `HOOK_INITIATIVE_CHECK` 强制先手，支持优先级控制（梦境优先级 95 > 威压 90）
     - **状态修正类**（搅乱、奇迹、本能、激怒）：修正命中/回避/暴击等核心判定参数
     - **特殊机制类**（气魄、努力、拖延、执念、再动）：通过回调函数实现复杂逻辑（如气魄在造成伤害时 +3 气力）
   - **数据驱动原则**：所有精神指令都是 JSON 配置 + 代码回调的组合，避免了硬编码。例如"奇迹"通过 `operation="callback"` 调用 `cb_miracle_hit`，将 MISS 强制转为 HIT。

2. **机体特性（Traits）的丰富化**
   - **逻辑变化**：新增 14 个机体特性回调函数，包括：
     - **防御型**：自动修复（回复 20% 受到伤害）、烧蚀装甲（光束伤害 -200）、再生（每回合 +5% HP）
     - **资源管理型**：快速装填（攻击结束 +15 EN）、省能源（每回合 +5 EN）、士气（战斗结束 +30 EN）
     - **进攻型**：吸血（回复 10% 伤害）、气魄（造成伤害时 +3 气力）、看破（暴击率 +25%）
     - **条件触发型**：本能（30% 概率 HIT→DODGE）、超反应（气力 ≥ 120 时招架率 +15%）
   - **设计思路**：建立"固有特性"与"精神指令"的清晰界限。特性是永久或长期生效的机体性能（如"GN炉回复"），而精神指令是临时爆发。这为机体差异化提供了基础——同样装备下，不同机体的战斗风格截然不同。

3. **木桩模拟器的数值验证工具化**
   - **逻辑变化**：将 `sim/sim_challenge_boss.py` 从简单的 Boss 挑战工具重构为完整的数值验证系统。新增 `BattleStatsCollector` 数据类，收集回合数分布、判定结果分布、伤害分布、精神指令使用频率等 8 项统计数据。
   - **设计思路**：模拟器不同于测试——测试验证"代码是否正确"，模拟器探索"数值是否合理"。通过 10+ 轮自动模拟，统计以下关键指标：
     - **平均战斗时长**：验证 Boss HP 与玩家 DPS 的平衡性（预期 20-30 回合结束）
     - **判定结果分布**：验证圆桌判定的概率是否预期（如暴击率应该接近 20%）
     - **精神指令使用率**：分析哪些指令被高频使用，是否存在"最优解"滥用
   - **配置集中化**：将 Boss 和挑战者的参数集中在文件顶部的配置字典中，方便数值策划快速调整（如将 Boss HP 从 500000 改为 1000000）而无需深入代码。

4. **测试覆盖率的深度补全**
   - **逻辑变化**：在 `tests/test_integration_complex.py` 中新增 5 个覆盖率测试，覆盖 `engine.py` 中之前未测试的代码路径：
     - `test_initiative_forced_switch`：测试连续获胜达到阈值后的强制换手机制（Consecutive Wins Threshold）
     - `test_initiative_hook_forces_first_attacker`：测试钩子干预先手判定的边缘场景
     - `test_determine_initiative_reason_will_diff`：测试气力差异 ≥ 20 时的先手原因判定
     - `test_weapon_selector_filters_out_of_range`：测试武器选择过滤超出射程的逻辑
     - 多个武器优先级和可用性测试
   - **设计思路**：通过 `pytest-cov` 工具发现覆盖盲区，然后针对性补全。先手判定、武器选择是战斗系统的核心入口，必须 100% 覆盖。同时，这些测试也验证了钩子系统是否真正生效（如"梦境"能否强制先手）。

5. **测试代码的现代化适配**
   - **逻辑变化**：
     - `tests/test_loader.py`：适配 Pydantic v2 的字段结构（`stats.shooting` → `stat_shooting`，移除 `proficiency` 字段），从 433 行精简到更清晰的测试数据结构。
     - `tests/test_resolver_coverage.py`：标注了 TODO，将熟练度相关测试标记为"等待新系统实现"，因为熟练度字段已从 PilotConfig 移除，改为通过技能系统实现。
   - **设计思路**：测试代码与业务代码同步重构。当模型字段变更时，测试数据必须立即适配，否则测试会变成"虚假的通过"（在测试旧逻辑）。同时，明确标注哪些功能已废弃或待实现，避免后续维护者困惑。

6. **文档的同步更新**
   - **逻辑变化**：`doc/2.skill_system_design.md` 和 `doc/4.stat_equip_design.md` 有小幅更新，补充了新增精神指令和特性的说明。
   - **设计思路**：代码变更必须同步到设计文档，否则文档会变成"历史遗迹"。特别是技能系统设计文档，是 AI 和人类开发者理解技能配置的权威参考，必须保持最新。

**技术要点**
- 回调函数通过 `@SkillRegistry.register_callback` 装饰器注册，支持任意复杂的逻辑（如状态查询、概率判定、资源修改）
- 精神指令的 JSON 配置支持优先级（priority）和持续时间（duration），实现了"临时爆发"与"持续生效"的区分
- 统计分析使用 `collections.Counter` 和 `defaultdict` 高效收集战斗数据，避免手动维护复杂的统计变量
- 测试覆盖率通过 `pytest-cov --cov=src/combat/engine --cov-report=term-missing` 生成缺失行报告

**后续计划**
1. 完善"熟练度"系统的技能化实现（将 `weapon_proficiency` 转化为技能效果）
2. 编写更多技能组合的集成测试（如"热血 + 气魄 + 看破"的极限伤害场景）
3. 将木桩模拟器的统计结果导出为 CSV/JSON，支持数值策划的批量分析

---

## 2025-02-10 测试框架现代化：从 unittest 迁移到 pytest

> **项目快照**：代码文件 13 个（2607 行）| 设计文档 4 个（1670 行）

### 逻辑变化与核心思路

1. **测试基础设施的全面重构**
   - **逻辑变化**：从标准库的 unittest 迁移到 pytest 框架，删除了8个旧的 unittest 测试文件，新增了11个 pytest 测试文件（共5475行）。新增 `pytest.ini` 配置文件和 722 行的 `conftest.py` 共享配置。
   - **设计思路**：unittest 在实际使用中暴露了三个核心痛点：（1）测试数据重复编写，每个测试都要手动创建 `Mecha`、`Pilot` 等对象；（2）随机数（RNG）难以控制，导致测试结果不稳定；（3）缺少测试标记，无法针对性地运行某类测试。pytest 的 fixture 机制和参数化测试能力更契合回合制游戏的测试需求。

2. **测试数据的标准化复用（Fixture体系）**
   - **逻辑变化**：在 `conftest.py` 中定义了大量可复用的 Fixtures，覆盖了游戏中的各种场景：
     - 基础对象：`basic_pilot`、`basic_mecha`、`basic_weapon`
     - 特殊机体：`low_hp_mecha`（30% HP，测试底力技能）、`high_will_mecha`（气力150，测试大招）、`high_hit_mecha`（命中率80%）、`high_dodge_mecha`（躲闪率50%）
     - 边界条件：`zero_hp_mecha`、`zero_en_mecha`、`max_will_mecha`
     - 效果对象：`effect_add_hit`、`effect_mul_damage`、`effect_set_hit`、`effect_conditional_low_hp` 等
     - 完整机体：`gundam_rx78`（带王牌驾驶员和完整武器配置）、`zaku_ii`（平衡型机体）
   - **设计思路**：建立测试数据标准库，避免每个测试都瞎编数据。通过 Fixture 的依赖注入机制（如 `basic_mecha(basic_pilot)`），实现测试数据的组合和复用。例如 `low_hp_mecha` 可以直接继承 `basic_pilot`，无需重复定义驾驶员属性。

3. **随机数的严格 Mock 机制**
   - **逻辑变化**：所有涉及随机性的测试都使用 `@patch('random.uniform', return_value=0.5)` 强制固定随机结果。例如 `test_miss_result` 中，通过 `mock_uniform.return_value = 0.5` 确保攻击落在 Miss 区间。
   - **设计思路**：回合制游戏充满随机（命中率80%、暴击率25%），测试不能随机。必须 Mock 掉所有 RNG，确保测试结果100%可复现。这样当测试 Fail 时，我们能确定是代码逻辑出错了，而不是运气不好。这是 CI/CD 自动化的前提条件。

4. **测试分层的清晰化**
   - **逻辑变化**：测试文件按职责划分为：
     - `test_unit_models.py`：数据结构单元测试（Pilot、Mecha、Weapon 的字段验证）
     - `test_combat_resolver.py`：圆桌判定逻辑测试（Miss/Dodge/Parry/Block/Crit/Hit 六种结果）
     - `test_resolver_coverage.py`：熟练度/地形/武器类型覆盖测试
     - `test_side_effects.py`：副作用测试（HP/EN/Will 变化）
     - `test_complex_scenarios.py`：复杂场景集成测试（RX-78 vs 扎古，多回合完整战斗）
     - `test_integration_complex.py`：多技能组合测试
   - **设计思路**：不追求100%覆盖率，只测核心的战斗逻辑和技能数值。UI显示、配置加载、日志记录等辅助功能完全不用测，避免过度设计。测试是为了保证"改动代码时游戏别崩"，而不是为了刷覆盖率。

5. **自动化清理与隔离性保障**
   - **逻辑变化**：在 `conftest.py` 中定义了 `@pytest.fixture(autouse=True)` 的 `reset_skill_registry()`，在每个测试结束后自动清理 `SkillRegistry._hooks` 和 `SkillRegistry._callbacks`。
   - **设计思路**：防止测试之间的相互污染。例如测试A注册了一个"底力"技能的回调，如果测试B执行时没有清理，可能会意外触发测试A的回调，导致测试B失败。自动清理机制确保每个测试都在干净的环境中运行。

6. **新增 pytest_framework_plan.md 测试指南**
   - **逻辑变化**：新增测试指南文档（4154字节），定义了测试的目录结构、命名规范、核心策略。
   - **设计思路**：为 AI 和人类开发者提供统一的测试编写规范。核心原则是"不做过度设计"，强调三个关键点：
     - 必须 Mock 随机性（RNG）
     - 复用 Fixtures，禁止硬编码测试数据
     - 关注"数值变化"和"状态流转"，而非代码语法
   - 提供了测试分层路线图：阶段一（核心算子：伤害公式、命中公式）→阶段二（技能效果：几百个技能的生效验证）→阶段三（游戏循环：完整回合的集成测试）

7. **新增 sim/ 模拟器目录**
   - **逻辑变化**：新增 `sim_attack_table.py`（14615字节）和 `sim_challenge_boss.py`（9723字节）。
   - **设计思路**：模拟器与测试不同，测试是为了验证正确性，模拟器是为了探索数值分布。`sim_attack_table.py` 运行 5000+ 次迭代统计，验证攻击判定表在不同数值分布下的表现是否符合概率预期（标准场景、高命中、高闪避、极端压制）。这是数值策划的工具，不属于自动化测试范畴。

8. **测试标记系统与分组执行**
   - **逻辑变化**：在 `pytest.ini` 中定义了测试标记（unit、integration、combat、skill、stress、slow），支持通过 `pytest -m combat` 只运行战斗相关测试。
   - **设计思路**：提高开发效率。在开发战斗系统时，只运行 combat 标记的测试，避免被集成测试拖慢速度。在提交前运行完整测试套件，确保没有破坏现有功能。

**技术要点**
- pytest 的 fixture 机制比 unittest 的 setUp/tearDown 更灵活，支持依赖注入和作用域控制
- 使用 `@pytest.mark.parametrize` 支持参数化测试，例如一次性测试所有地形的修正效果
- 通过 `autouse=True` 实现自动清理，无需在每个测试中手动调用 tearDown
- 测试命名更加清晰：`test_<行为>_<预期结果>`（如 `test_attack_hit_should_reduce_hp`），通过命名就能理解测试意图

**后续计划**
根据 `pytest_framework_plan.md` 的路线图：
1. 阶段一：核心算子测试（伤害公式、命中公式、距离修正）
2. 阶段二：技能效果测试（几百个技能的生效验证，如"底力L9且HP<10%时防御力x1.5"）
3. 阶段三：游戏循环测试（完整回合的集成测试，验证双方最终HP/EN变化）

---

## 2026-02-10 技能系统全面落成与数据驱动重构

> **项目快照**：代码文件 24 个（3847 行）| 设计文档 5 个（1335 行）

### 逻辑变化与核心思路

1. **技能系统全链路实现与极端压力验证**
   - **逻辑变化**：完成了 `EffectProcessor`（优先级流水线）、`ConditionChecker`（上下文感知逻辑）、`SideEffectExecutor`（链式副作用）和 `EffectFactory`（数据驱动工厂）的闭环实现。
   - **设计思路**：通过一个包含 8 个并发异构技能（包括"不屈"、"预判"、"热血"、"节能"等）的极端压力测试，验证了系统对优先级冲突、跨阶段 Hook 引用及生命周期管理的支撑能力。系统成功从"能够运行"进化为"工业级鲁棒"。
   - **Bug 修复**：在自残测试场景中发现了效果重复收集的隔离性问题。通过在收集阶段引入 `id()` 过滤机制，确保了同一机体在同一 Hook 计算中无论扮演何种角色，其产生的 Effects 只会被计算一次，保证了幂等性。

2. **从硬编码向 JSON 数据驱动转型**
   - **逻辑变化**：彻底重构 `EffectFactory`，使其支持从 `data/skills.json` 动态加载数据。`TraitManager` 也不再包含具体数值，而是作为从 JSON 数据到 Effect 实例的桥梁。
   - **设计思路**：实现了游戏平衡与逻辑引擎的彻底解耦。数值策划现在可以通过修改 JSON 配置文件直接添加新技能、调整倍率或修改触发条件（如将"底力"的 HP 阈值从 0.3 改为 0.5），而无需触碰任何 Python 核心代码。

3. **战斗流程控制权的"Hook 化"**
   - **逻辑变化**：在 `engine.py` 中引入了 `HOOK_MAX_ROUNDS` 和 `HOOK_CHECK_MAINTAIN_BATTLE`，并在 `_execute_attack` 中集成了 `HOOK_PRE_EN_COST_MULT`。
   - **设计思路**：将战斗的"生死大权"也交给技能系统。这使得实现"死斗"（不限回合）、"剧情强制脱离"或"节能型机体特性"变得极其简单，只需挂载相应的 Hook 即可，无需在 Engine 类中编写冗长的 `if-else`。

4. **圆桌判定算法的精确化重构**
   - **逻辑变化**：将 `AttackTableResolver` 中的随机数从 `randint` 升级为 `uniform(0, 100)`，并重写了判定切片（Slices）逻辑。
   - **设计思路**：解决了整数随机带来的"101个整数导致的1%偏移"问题。新的"绝对宽度切片"算法不再依赖剩余百分比缩放，而是基于绝对数值宽度进行区间划分。这使得"必中"、"分身"等边界技能在面对高精准、高暴击时表现得更加符合概率预期，计算逻辑也更直观。

5. **动态逻辑的回调扩展 (Callback System)**
   - **逻辑变化**：实现了 `operation="callback"` 机制，并通过装饰器注册了"底力"、"学习电脑"和"GN炉"等复杂逻辑函数。
   - **设计思路**：虽然 JSON 能够覆盖 90% 的数值修正，但总有 10% 的奇葩技能（如按比例回能、指数级属性成长）需要代码介入。回调系统作为"逃生门"，确保了系统在保持数据驱动的同时，不丧失处理极端复杂机制的灵活性。

---

## 2026-02-09 技能系统架构设计与文字演出精简

> **项目快照**：代码文件 12 个（1887 行）| 设计文档 3 个（2312 行）

### 逻辑变化与核心思路

1. **技能系统的完整设计蓝图**
   - **逻辑变化**：新增 [skill_system_design.md](doc/skill_system_design.md)（766行），定义了基于 Pipeline 架构的完整技能系统。设计了 30 个钩子点，覆盖从先手判定到伤害结算的全流程。
   - **设计思路**：贯彻"逻辑与数值分离"的核心理念。战斗主循环只负责流程控制和"埋点"（Hooks），所有的数值修正、机制判定均通过技能效果（Effects）挂载到钩子点上实现。这四大类技能效果：临时增加数值、概率增加数值、临时确定判定、概率确定判定，覆盖了从"集中"（永久加成）到"分身"（概率触发）的所有经典机战技能需求。
   - **关键创新**：跨钩子点引用机制——允许技能引用其他钩子点的计算结果。例如"见切"可以引用对方的命中率（来自 `HOOK_PRE_HIT_RATE`），在对方命中率低于30%时才触发招架率加成。通过 `cached_results` 缓存 + 递归死锁防护解决了循环依赖问题。

2. **状态生命周期管理体系**
   - **逻辑变化**：设计了四种状态生命周期（ATTACK_BASED / TURN_BASED / BATTLE_BASED / GLOBAL），明确了何时清理临时状态。
   - **设计思路**：解决"精神指令何时失效"的棘手问题。例如"热血"是仅限本次攻击有效（ATTACK_BASED），"集中"是持续1回合（TURN_BASED），而"学习电脑层数"则是整场战斗有效（BATTLE_BASED）。通过在特定钩子点（如 `HOOK_ON_ATTACK_END`）触发清理，实现了精确的状态管理，避免内存泄漏和逻辑错误。

3. **文字演出的精简优化**
   - **逻辑变化**：简化了 [combat_presentation.md](doc/combat_presentation.md) 中的环境描述模板，去除冗余的修饰词（如"猛然开启"、"深深的"），使文本更直接有力。
   - **设计思路**：之前的模板过于华丽，导致单回合文本过长（约150字），影响阅读节奏。优化后的模板控制在80-100字内，保留核心信息（距离、先手原因、武器效果），去除多余的形容词堆砌。例如将"米诺夫斯基粒子在5200m外形成淡淡的干扰波纹"简化为"凭借卓越的机体性能在5200m处率先完成瞄准"——省去物理设定，聚焦战术动作本身。

---

## 2026-02-09 战斗叙事与术语体系完善

> **项目快照**：代码文件 12 个（2045 行）| 设计文档 2 个（781 行）

### 逻辑变化与核心思路

1. **战斗核心概念重构：从"优势值"到"气力系统"**
   - **逻辑变化**：将原本模糊的"优势值"概念替换为更具体的"气力"系统，这个改动贯穿整个战斗设计。
   - **设计思路**："气力"作为驾驶员战意与机体性能发挥的结合点，不仅在数值上影响伤害/防御修正，还直接决定先攻权判定。相比抽象的"优势"，气力能通过攻击命中、招架、格挡等具体动作实时增减，让战意积累的过程可视化、可预测。

2. **资源限制机制的引入：EN消耗与战术脱离**
   - **逻辑变化**：新增EN检查环节，在攻击判定前先确认"当前EN >= 武器消耗"，不满足则无法攻击。同时新增"战术脱离"结局——EN不足但成功防御可强制中止战斗。
   - **设计思路**：这是对传统机战游戏的致敬。武器不再是无限使用的，玩家必须管理机体能量。更关键的是，"战术脱离"给劣势方留出了体面退出的通道——即使打不过，通过精明的防御也能保住机体撤退，这比单纯的"战败"更有策略深度。

3. **圆桌判定系统的气力反馈闭环**
   - **逻辑变化**：防御类判定（躲闪/招架/格挡）现在会为防御方提供气力奖励（躲闪+5、招架+15、格挡+5），而不仅仅是"未受伤"。
   - **设计思路**：建立"防御得利"的反馈循环。弱势方即使无法反击，通过连续招架/格挡也能快速积累气力，在后续回合通过高气力反超先攻权，实现"以守为攻"的战术路线。

4. **叙事视角的动态切换机制**
   - **逻辑变化**：文字演出不再是固定的"攻击方视角"，而是根据圆桌判定结果动态选择——命中类（Miss/Hit/Crit）从攻击方描述武器威力，防御类（Dodge/Parry/Block）从防御方描述机体机动性。
   - **设计思路**：这样能最大化每个回合的信息密度。当判定为"招架"时，读者更想看到的是"防御方如何巧妙化解攻击"，而不是"攻击方打空了"。视角切换让每种判定结果都有其独特的叙事张力。

5. **术语风格的统一化与沉浸感提升**
   - **逻辑变化**：新增完整的"属性展示名称映射表"，将所有内部代码（hp、en、will等）映射为机器人动画风格的术语（机体耐久、能量出力、气力），并标注术语来源（高达UC、Franxx、机动警察等）。
   - **设计思路**：前端显示的"能量出力：45/80"比"EN：45/80"更有代入感。更关键的是，统一术语风格能让玩家快速建立认知框架——看到"NT等级"就知道是新人类相关，看到"I力场格挡"就能联想到高达的技术设定。这种细节打磨在长期游玩中会形成强烈的世界观沉浸感。

---

## 2026-02-09 战斗系统底层架构重构

> **项目快照**：代码文件 12 个（1769 行）| 设计文档 2 个（781 行）

### 逻辑变化与核心思路

1. **架构进化：从"静态属性修正"转向"流水线钩子系统"**
   - **逻辑变化**：重构了战斗计算流程。不再在初始化时将加成固定在属性上，而是引入了 `SkillRegistry` 钩子系统。命中判定、伤害计算、减伤判定等每一个核心数值环节都变成了可干预的"管道"。
   - **设计思路**：为了后续支持无限扩展的技能（如 SRW 中的"必中"、"热血"、"底力"等），必须让战斗引擎与具体的技能逻辑解耦。现在引擎不再关心有哪些技能，只需在计算时向注册表"询问"是否存在修改者。

2. **状态系统的生命周期化 (Effect & Tick Mechanism)**
   - **逻辑变化**：引入了 `EffectManager` 和有时效性的 `Effect` 模型。精神指令（Spirit Commands）现在作为带持续回合的状态存在，并在回合结束时通过 `tick_effects` 自动衰减。
   - **设计思路**：为了精确复刻机战中"仅限本回合有效"或"仅限下次攻击有效"的策略感。将"临时状态"从"机体基础性能"中彻底分离。

3. **机体特性的标准化注入 (TraitManager)**
   - **逻辑变化**：新增 `TraitManager`，专门负责机体固有特性（如"学习型计算机"、"强化装甲"）的统一点火。
   - **设计思路**：建立清晰的属性修正层级：机体基础值 -> 固有特性修正 -> 战场临时状态加成。这为未来的"二周目继承"或"机体改造"预留了干净的接口。

4. **战场上下文 (BattleContext) 的角色升级**
   - **逻辑变化**：`BattleContext` 增加了对地形（Terrain）和事件标记（Event Flags）的支持，并成为所有钩子函数的必传参数。
   - **设计思路**：逻辑不再是孤岛。通过上下文，技能可以感知当前是"我方回合"还是"敌方反击"，以及当前处于"宇宙"还是"基地"，从而实现复杂的地形相关技能或反击专用技能。

---

## 项目起始阶段小结 (2026-01-XX 至 2026-02-07)

> **项目快照**（2026-02-07 纯设计阶段）：代码文件 0 个（0 行）| 设计文档 2 个（54 行）

### 设计定型：核心战斗框架与叙事体系的建立

在2月8日进入代码实现阶段之前，项目经历了完整的设计定型期。这一阶段的核心成果是将抽象的机器人战斗概念转化为可落地的设计规范。

#### 1. 战斗核心机制的设计确立

**圆桌判定系统的提出**
- 从传统RPG的"命中/未命中"二元判定，转向更复杂的"单一随机数圆桌系统"。将Miss（12%）、Dodge（22%）、Parry（15%）、Block（20%）、Crit（25%）、Hit（剩余）按照优先级排列，让每个判定结果都有其战术价值。
- 设计思路：避免"概率堆砌"的数值膨胀，通过"精准"属性削减敌方防御区间，建立攻击与防御的博弈空间。

**动态距离机制的引入**
- 打破传统回合制战斗的"立桩对射"，设计了从3000-7000m开始、每回合缩进1500m的动态距离系统。强制玩家同时装备格斗、射击、狙击三类武器。
- 设计思路：体现真实系机器人的战场感，距离不再是一个静态标签，而是每回合随机抽取的具体数值，带来武器可用性的不确定性。

**优势值（后改为气力）系统的概念化**
- 最初提出"优势值"作为核心资源，通过攻击命中、招架格挡等动作积累，影响先攻权判定。防御方可以通过完美防守获得大量优势，实现"以守为攻"的反超路线。
- 设计思路：建立动态平衡机制，防止强势方无脑滚雪球，给弱势方留出翻盘通道。

#### 2. 叙事视角的结构化

**标准四段式演出模板**
- 提出战场环境、先手攻击、后手反击、回合总结的四段式结构，单回合字数控制在100-150字。
- 关键创新：根据圆桌判定结果动态切换叙事视角——命中类从攻击方描述武器威力，防御类从防御方描述机体机动性。最大化每回合的信息密度。

**示例驱动的文档风格**
- 通过完整的4回合战斗示例（高达VS扎古），展示从雷达接触到最终决战的全过程。让开发者能直观理解"初动-接敌-死斗-决战"的节奏变化。

#### 3. 从设计到实现的准备

这一阶段虽然没有代码，但设计文档已经明确规定了：
- 数据模型所需的字段（机体、驾驶员、武器三大类属性）
- 圆桌判定的优先级公式
- 先手权的分层判定逻辑（绝对优先权→综合优势判定）
- 文本演出的API接口格式（Environment、Action、Summary三类模板）

这些设计规范直接指导了后续的代码架构（如SkillRegistry钩子系统、BattleContext上下文对象）的设计方向。

#### 4. 设计文档的演进

从git历史可以看到，设计文档经历了三轮迭代：
- f31e6c1（战斗文档设定更新）：初步建立战斗框架
- d7f33fe（优化战斗设计和文字演出细节）：完善圆桌判定和距离机制
- afc57f2（进一步优化文字演出设计）：定型四段式叙事和视角切换逻辑

每一次迭代都在细节上打磨，为2月9日的代码实现阶段扫清了概念障碍。

---
